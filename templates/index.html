<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Stock Fundamentals — Home</title>
    <link rel="stylesheet" href="/static/styles.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    {% include '_header.html' %}

    <main class="hero">
      <div class="hero-inner">
        <h1 class="hero-title">Explore stocks with confidence</h1>
        <p class="hero-sub">
          Fast, explainable stock analysis and guided research assignments
          tailored to your learning stage.
        </p>

        <form
          class="search-form"
          action="/analyze"
          method="post"
          autocomplete="off"
        >
          <input
            type="hidden"
            name="challenge_mode"
            id="challenge_mode_hidden"
            value="normal"
          />
          <div class="search-row">
            <input
              id="ticker-input"
              name="ticker"
              type="text"
              placeholder="Search company or ticker (e.g. TCS, INFY)"
              required
            />
            <button class="cta" type="submit">Analyze</button>
          </div>
          <ul id="suggestions-list" class="suggestions"></ul>
          <div class="modes">
            <label class="mode">
              <input
                type="radio"
                name="challenge_mode"
                value="normal"
                checked
              />
              <div class="mode-box">
                <strong>Standard</strong>
                <span>Automated multi-tool analysis</span>
              </div>
            </label>
            <label class="mode">
              <input
                type="radio"
                name="challenge_mode"
                value="tool_independence"
              />
              <div class="mode-box">
                <strong>Tool Independence</strong>
                <span>Practice manual analysis skills</span>
              </div>
            </label>
          </div>
        </form>

        <div class="hero-features">
          <div class="feature">
            <h4>Personalized research</h4>
            <p>
              Assignments created from detected analysis gaps — focused,
              actionable, India-first.
            </p>
          </div>
          <div class="feature">
            <h4>Track progress</h4>
            <p>Earn badges and get notified when milestones are reached.</p>
          </div>
          <div class="feature">
            <h4>Explainable outputs</h4>
            <p>
              Qualitative rubrics for moats, management and industry analysis.
            </p>
          </div>
        </div>
      </div>
    </main>

    <section class="showcase">
      <div class="container">
        <h2>Recent analyses</h2>
        <div class="cards" id="recent-cards">
          <!-- placeholder cards populated by JS if available -->
        </div>
      </div>
    </section>

    {% include '_footer.html' %}

    <script>
      // Suggestion fetch (handles server returning either an array of objects or a mapping)
      const input = document.getElementById("ticker-input");
      const suggestions = document.getElementById("suggestions-list");

      let timeout = null;
      let activeIndex = -1;
      const listRoot = suggestions;

      input &&
        input.addEventListener("input", (e) => {
          clearTimeout(timeout);
          const q = e.target.value.trim();
          if (!q || q.length < 2) {
            suggestions.innerHTML = "";
            return;
          }
          timeout = setTimeout(async () => {
            try {
              const res = await fetch(
                `/suggest?query=${encodeURIComponent(q)}`
              );
              const data = await res.json();
              suggestions.innerHTML = "";
              // support { suggestions: { name: ticker, ... } } or { suggestions: [{name,ticker}, ...] }
              const raw = data.suggestions;
              if (!raw) return;
              function makeLi(text, ticker) {
                const li = document.createElement("li");
                li.textContent = text;
                li.dataset.ticker = ticker;
                li.addEventListener("click", () => {
                  input.value = ticker;
                  suggestions.innerHTML = "";
                  input.focus();
                  const pos = input.value.length;
                  try {
                    input.setSelectionRange(pos, pos);
                  } catch (e) {}
                });
                return li;
              }

              if (Array.isArray(raw)) {
                raw.forEach((s) =>
                  suggestions.appendChild(
                    makeLi(`${s.name} (${s.ticker})`, s.ticker)
                  )
                );
              } else if (typeof raw === "object") {
                Object.keys(raw).forEach((name) =>
                  suggestions.appendChild(
                    makeLi(`${name} (${raw[name]})`, raw[name])
                  )
                );
              }
              activeIndex = -1;
              // reset active class
              Array.from(listRoot.children).forEach((n) =>
                n.classList.remove("active")
              );
            } catch (err) {
              console.warn("suggest fail", err);
            }
          }, 200);
        });

      // keyboard navigation for suggestions
      input &&
        input.addEventListener("keydown", (e) => {
          const items = Array.from(listRoot.children);
          if (!items.length) return;
          if (e.key === "ArrowDown") {
            e.preventDefault();
            activeIndex = Math.min(items.length - 1, activeIndex + 1);
            items.forEach((it, i) =>
              it.classList.toggle("active", i === activeIndex)
            );
            items[activeIndex].scrollIntoView({ block: "nearest" });
          } else if (e.key === "ArrowUp") {
            e.preventDefault();
            activeIndex = Math.max(0, activeIndex - 1);
            items.forEach((it, i) =>
              it.classList.toggle("active", i === activeIndex)
            );
            items[activeIndex].scrollIntoView({ block: "nearest" });
          } else if (e.key === "Enter") {
            // if a suggestion is active, choose it and do NOT submit form
            if (activeIndex >= 0 && items[activeIndex]) {
              e.preventDefault();
              const chosen = items[activeIndex];
              input.value = chosen.dataset.ticker || input.value;
              suggestions.innerHTML = "";
              input.focus();
            }
          } else if (e.key === "Escape") {
            suggestions.innerHTML = "";
            activeIndex = -1;
          }
        });

      // Sync challenge_mode hidden field with radios and make boxes clickable
      function syncModeHidden() {
        const checked = document.querySelector(
          '.modes input[type="radio"]:checked'
        );
        const hidden = document.getElementById("challenge_mode_hidden");
        if (checked && hidden) hidden.value = checked.value;
      }

      document.querySelectorAll(".mode-box").forEach((box) => {
        box.addEventListener("click", () => {
          const input = box.parentElement.querySelector('input[type="radio"]');
          if (input) {
            input.checked = true;
            syncModeHidden();
            try {
              input.dispatchEvent(new Event("change", { bubbles: true }));
            } catch (e) {}
            try {
              refreshModeHighlights();
            } catch (e) {}
          }
        });
        box.addEventListener("mouseenter", () => {
          try {
            box.classList.add("highlight");
          } catch (e) {}
        });
        box.addEventListener("mouseleave", () => {
          try {
            refreshModeHighlights();
          } catch (e) {}
        });
      });

      document
        .querySelectorAll('.modes input[type="radio"]')
        .forEach((r) => r.addEventListener("change", syncModeHidden));

      // update visual highlight for selected mode-box
      function refreshModeHighlights() {
        document.querySelectorAll(".mode").forEach((label) => {
          const box = label.querySelector(".mode-box");
          const radio = label.querySelector('input[type="radio"]');
          if (box && radio) box.classList.toggle("highlight", radio.checked);
        });
      }

      document.querySelectorAll('.modes input[type="radio"]').forEach((r) =>
        r.addEventListener("change", () => {
          syncModeHidden();
          refreshModeHighlights();
        })
      );
      // init highlight on load
      refreshModeHighlights();

      // Ensure hidden is synced before form submit
      document
        .querySelector(".search-form")
        .addEventListener("submit", syncModeHidden);

      // Recent analyses (if endpoint exists)
      (async function loadRecent() {
        try {
          const r = await fetch("/recent-analyses");
          if (!r.ok) return;
          const list = await r.json();
          const root = document.getElementById("recent-cards");
          root.innerHTML = "";
          (list || []).slice(0, 6).forEach((it) => {
            const c = document.createElement("div");
            c.className = "card";
            c.innerHTML = `<strong>${it.ticker}</strong><small>${
              it.title || ""
            }</small><p>${it.summary || ""}</p>`;
            root.appendChild(c);
          });
        } catch (e) {}
      })();
    </script>
  </body>
</html>
