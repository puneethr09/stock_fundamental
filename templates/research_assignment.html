<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Research Assignment</title>
    <link rel="stylesheet" href="/static/styles.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
  </head>
  <body class="research-page">
    {% include '_header.html' %}
    <div class="container">
      <h1>{{ assignment.title }}</h1>
      {% if assignment.company %}
      <h3>{{ assignment.company }}</h3>
      {% endif %}

      <p><strong>Category:</strong> {{ assignment.category }}</p>
      <p><strong>Difficulty:</strong> {{ assignment.difficulty }}</p>
      <p>
        <strong>Estimated time:</strong> {{ assignment.time_estimate_minutes }}
        minutes
      </p>

      <h4>Instructions</h4>
      <ol class="list-group list-group-flush">
        {% for step in assignment.instructions %}
        <li class="list-group-item">{{ step }}</li>
        {% endfor %}
      </ol>

      <h4>Success Criteria</h4>
      <ul class="list-group list-group-flush">
        {% for c in assignment.success_criteria %}
        <li class="list-group-item">{{ c }}</li>
        {% endfor %}
      </ul>

      <hr />
      <h3>Submit Completion</h3>
      <form id="completion-form" class="row">
        <div class="col-12 mb-3">
          <label for="summary" class="form-label"
            >Summary (200-300 words)</label
          >
          <textarea
            id="summary"
            name="summary"
            rows="6"
            class="form-control"
          ></textarea>
        </div>

        <div class="col-12 mb-3">
          <label for="evidence" class="form-label"
            >Evidence / sources (comma-separated)</label
          >
          <input id="evidence" name="evidence" class="form-control" />
        </div>

        <input
          type="hidden"
          id="assignment_id"
          value="{{ assignment.assignment_id }}"
        />
        <div class="col-12">
          <button
            id="submit-btn"
            type="button"
            class="btn btn-primary"
            style="min-height: 44px"
          >
            Submit Completion
          </button>
        </div>
      </form>

      <div
        id="result"
        class="alert alert-info mt-3"
        style="display: none"
      ></div>
    </div>

    <script>
      document
        .getElementById("submit-btn")
        .addEventListener("click", async function () {
          const aid = document.getElementById("assignment_id").value;
          const summary = document.getElementById("summary").value;
          const evidence = document.getElementById("evidence").value;

          const payload = {
            user_id: null,
            completion: {
              summary: summary,
              evidence: evidence
                .split(",")
                .map((s) => s.trim())
                .filter(Boolean),
              duration: 600,
            },
          };

          const resp = await fetch(`/research-assignment/${aid}/complete`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await resp.json();
          const resultDiv = document.getElementById("result");
          resultDiv.style.display = "block";
          resultDiv.innerText = JSON.stringify(data, null, 2);
        });
    </script>
    {% include '_footer.html' %}
  </body>
</html>
