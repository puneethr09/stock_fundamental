<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Financial Ratios Analysis</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      integrity="sha384-k6RqeWeci5ZR/Lv4MR0sA0FfDOM5M8Q4gZQ1S5r5l5g5r5g5r5g5r5g5r5g5r5g5"
      crossorigin="anonymous"
    />
    <style>
      body {
        background-image: url("/static/images/wall_street_blue.avif");
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        background-attachment: fixed;
      }
      h1.text-center {
        color: rgb(255, 255, 255); /* Change this to your desired color */
      }
      .data {
        background: rgba(255, 255, 255, 0.5); /* White with 80% opacity */
        width: 90%;
        margin: 20px auto;
        border-collapse: collapse;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      }
      .data th {
        background-color: rgba(0, 123, 255, 0.5); /* Blue with 80% opacity */
        color: white;
        font-weight: bold;
        padding: 12px;
        text-align: center;
      }
      .data td {
        padding: 10px;
        text-align: right;
        border: 1px solid rgba(221, 221, 221, 0.5); /* Light grey with 80% opacity */
        background-color: rgba(255, 255, 255, 0.5); /* White with 80% opacity */
      }
      .data tr:nth-child(even) td {
        background-color: rgba(
          240,
          247,
          255,
          0.5
        ); /* Light blue with 80% opacity */
      }
      .data tr:hover td {
        background-color: rgba(
          245,
          245,
          245,
          0.5
        ) !important; /* Light grey with 80% opacity */
      }
      .plot {
        text-align: center;
        margin: 20px;
        background-color: rgba(255, 255, 255, 0.5); /* White with 80% opacity */
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .positive {
        color: #067320;
      }
      .negative {
        color: #dc3545;
      }
      .warning {
        color: #ff6b6b;
        font-weight: 500;
        text-align: center;
        padding: 10px;
        line-height: 1.5;
      }
      .explanation {
        color: #2c3e50;
        text-align: center;
      }
      /* .plot {
        text-align: center;
        margin: 20px;
      } */
      .navbar-search {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        width: auto;
      }
      #another-ticker-input {
        width: 250px;
        height: 35px;
        font-size: 14px;
        padding: 5px 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        border-color: #007bff;
        border-width: 3px;
        background-color: #f0f8ff;
        color: #333;
      }
      #suggestions-list {
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        width: 250px;
        max-height: 300px;
        overflow-y: auto;
        background: white;
        border: 1px solid #ccc;
        border-radius: 0 0 4px 4px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        z-index: 1000;
      }
      #suggestions-list li {
        padding: 8px 10px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
      }
      #suggestions-list li:last-child {
        border-bottom: none;
      }
      #suggestions-list li:hover {
        background-color: #f5f5f5;
      }
      .search-box input[type="submit"] {
        font-size: 1.5rem;
        padding: 0.8rem 2rem;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      .search-box input[type="submit"]:hover {
        background-color: #0056b3;
      }

      /* Educational Gaps Styles */
      .educational-gaps-section {
        background: rgba(255, 252, 240, 0.95);
        margin: 30px auto;
        width: 90%;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        border: 2px solid #ffc107;
      }

      .gaps-header {
        text-align: center;
        color: #dc6c00;
        margin-bottom: 25px;
        border-bottom: 2px solid #ffc107;
        padding-bottom: 10px;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px;
      }

      .confidence-badge {
        background: #28a745;
        color: white;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.8em;
        font-weight: normal;
      }

      .gaps-summary {
        margin-bottom: 25px;
      }

      .gap-item {
        background: rgba(255, 255, 255, 0.8);
        border-left: 4px solid #ffc107;
        margin: 15px 0;
        padding: 15px;
        border-radius: 0 8px 8px 0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .gap-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .gap-type {
        background: #ffc107;
        color: #333;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8em;
        font-weight: bold;
        text-transform: uppercase;
      }

      .gap-impact {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8em;
        font-weight: bold;
        text-transform: uppercase;
      }

      .gap-impact-low {
        background: #d4edda;
        color: #155724;
      }

      .gap-impact-medium {
        background: #fff3cd;
        color: #856404;
      }

      .gap-impact-high {
        background: #f8d7da;
        color: #721c24;
      }

      .gap-description {
        margin: 10px 0;
        color: #555;
        font-style: italic;
      }

      .gap-actions ul {
        margin: 5px 0 0 20px;
      }

      .research-guides {
        margin-top: 25px;
      }

      .research-guide {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid #ffc107;
        margin: 20px 0;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .guide-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .guide-header h5 {
        color: #dc6c00;
        margin: 0;
      }

      .guide-priority {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8em;
        font-weight: bold;
        text-transform: uppercase;
      }

      .guide-priority-low {
        background: #d4edda;
        color: #155724;
      }

      .guide-priority-medium {
        background: #fff3cd;
        color: #856404;
      }

      .guide-priority-high {
        background: #f8d7da;
        color: #721c24;
      }

      .guide-description {
        color: #555;
        margin-bottom: 15px;
        font-style: italic;
      }

      .research-questions, .information-sources, .expected-outcomes {
        margin: 15px 0;
      }

      .research-questions h6, .information-sources h6, .expected-outcomes h6 {
        color: #dc6c00;
        margin-bottom: 8px;
      }

      .sources-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
        margin: 10px 0;
      }

      .source-item {
        background: rgba(248, 249, 250, 0.8);
        padding: 12px;
        border-radius: 6px;
        border: 1px solid #dee2e6;
      }

      .source-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
      }

      .source-type {
        background: #6c757d;
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.7em;
        text-transform: uppercase;
      }

      .source-description {
        margin: 8px 0;
        font-size: 0.9em;
        color: #666;
      }

      .source-link {
        display: inline-block;
        background: #007bff;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        text-decoration: none;
        font-size: 0.85em;
        margin: 5px 0;
      }

      .source-link:hover {
        background: #0056b3;
        text-decoration: none;
        color: white;
      }

      .search-tips {
        margin-top: 8px;
        padding: 5px;
        background: rgba(255, 255, 255, 0.5);
        border-radius: 3px;
      }

      /* Community Insights Styles */
      .community-section {
        background: rgba(255, 255, 255, 0.9);
        margin: 30px auto;
        width: 90%;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .community-header {
        text-align: center;
        color: #007bff;
        margin-bottom: 20px;
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
      }

      .insight-card {
        background: rgba(248, 249, 250, 0.9);
        border-left: 4px solid #007bff;
        margin: 15px 0;
        padding: 15px;
        border-radius: 0 8px 8px 0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .insight-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .insight-category {
        background: #007bff;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8em;
        text-transform: uppercase;
      }

      .insight-date {
        color: #666;
        font-size: 0.85em;
      }

      .insight-content {
        margin: 10px 0;
        line-height: 1.5;
        color: #333;
      }

      .insight-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 15px;
        padding-top: 10px;
        border-top: 1px solid #dee2e6;
      }

      .vote-buttons {
        display: flex;
        gap: 10px;
      }

      .vote-btn {
        background: none;
        border: 1px solid #ccc;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.2s;
      }

      .vote-btn:hover {
        background: #f8f9fa;
      }

      .vote-btn.up:hover {
        background: #d4edda;
        border-color: #28a745;
        color: #155724;
      }

      .vote-btn.down:hover {
        background: #f8d7da;
        border-color: #dc3545;
        color: #721c24;
      }

      .flag-btn {
        background: none;
        border: none;
        color: #dc3545;
        cursor: pointer;
        font-size: 0.8em;
        text-decoration: underline;
      }

      .flag-btn:hover {
        color: #a71d2a;
      }

      .contribute-form {
        background: rgba(240, 248, 255, 0.9);
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 2px dashed #007bff;
      }

      .contribute-form h4 {
        color: #007bff;
        margin-bottom: 15px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #333;
      }

      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-family: inherit;
      }

      .form-group textarea {
        height: 100px;
        resize: vertical;
      }

      .submit-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1em;
        transition: background-color 0.2s;
      }

      .submit-btn:hover {
        background: #0056b3;
      }

      .no-insights {
        text-align: center;
        color: #666;
        font-style: italic;
        padding: 20px;
      }
      .home-button {
        position: absolute;
        top: 20px;
        right: 20px;
      }
      .home-button button {
        font-size: 1.5rem;
        padding: 0.8rem 2rem;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      .home-button button:hover {
        background-color: #0056b3;
      }
      .info-button {
        cursor: pointer;
        margin-left: 2px;
        color: #007bff;
        font-size: 0.6em;
        position: relative;
        vertical-align: middle;
        padding: 0;
        line-height: 1;
        display: inline-block;
      }

      .info-button:hover::after,
      .info-button:focus::after {
        content: attr(data-explanation);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: #333;
        color: #fff;
        padding: 10px 15px;
        border-radius: 5px;
        white-space: normal !important;
        width: 450px !important;
        max-width: 450px !important;
        min-width: 450px !important;
        text-align: left;
        z-index: 1000;
        font-size: 1.5em;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid">
        <a class="navbar-brand" href="{{ url_for('home') }}">Stock Analysis</a>
        <div class="navbar-nav ml-auto">
          <a class="nav-link" href="{{ url_for('home') }}">Home</a>
          <a class="nav-link" href="{{ url_for('news') }}">Market News</a>
        </div>
        <div class="navbar-search">
          <form
            action="{{ url_for('analyze') }}"
            method="get"
            class="form-inline"
          >
            <input
              type="text"
              id="another-ticker-input"
              name="ticker"
              placeholder="Search another stock"
              autocomplete="off"
              required
            />
            <ul id="suggestions-list"></ul>
          </form>
        </div>
      </div>
    </nav>
    <h1 class="text-center"><u>{{ company_name }}</u></h1>
    <div class="text-center">
      {% for table in tables %}
      <div class="table-responsive">{{ table|safe }}</div>
      {% endfor %}
    </div>
    <div class="warning">
      {% for warning, explanation in zip(warnings, explanations) %}
      <p>
        {{ warning }}
        <span class="info-button" data-explanation="{{ explanation }}">ℹ️</span>
      </p>
      {% endfor %}
    </div>
    <div class="plot">{{ plot_html | safe }}</div>

    <!-- Educational Gap-Filling Section -->
    {% if gaps or research_guides %}
    <div class="educational-gaps-section">
      <h2 class="gaps-header">
        <i class="fas fa-graduation-cap"></i> 📚 Learning Opportunities
        {% if confidence_score %}
        <span class="confidence-badge" title="Analysis Confidence: {{ "%.0f"|format(confidence_score * 100) }}%">
          Confidence: {{ "%.0f"|format(confidence_score * 100) }}%
        </span>
        {% endif %}
      </h2>

      {% if gaps %}
      <div class="gaps-summary">
        <h4><i class="fas fa-search"></i> Analysis Gaps Detected ({{ gaps|length }})</h4>
        <div class="gaps-list">
          {% for gap in gaps %}
          <div class="gap-item">
            <div class="gap-header">
              <span class="gap-type">{{ gap.gap_type.value.title() }}</span>
              <span class="gap-impact gap-impact-{{ gap.impact_level.value }}">
                {{ gap.impact_level.value.title() }} Impact
              </span>
            </div>
            <p class="gap-description">{{ gap.description }}</p>
            {% if gap.suggested_actions %}
            <div class="gap-actions">
              <strong>Suggested Actions:</strong>
              <ul>
                {% for action in gap.suggested_actions %}
                <li>{{ action }}</li>
                {% endfor %}
              </ul>
            </div>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      {% if research_guides %}
      <div class="research-guides">
        <h4><i class="fas fa-book"></i> Research Guides for {{ company_name }}</h4>
        {% for guide in research_guides %}
        <div class="research-guide">
          <div class="guide-header">
            <h5>{{ guide.title }}</h5>
            <span class="guide-priority guide-priority-{{ guide.priority.value }}">
              {{ guide.priority.value.title() }} Priority
            </span>
          </div>
          <p class="guide-description">{{ guide.description }}</p>
          
          {% if guide.research_questions %}
          <div class="research-questions">
            <h6><i class="fas fa-question-circle"></i> Key Research Questions:</h6>
            <ul>
              {% for question in guide.research_questions %}
              <li>{{ question }}</li>
              {% endfor %}
            </ul>
          </div>
          {% endif %}
          
          {% if guide.information_sources %}
          <div class="information-sources">
            <h6><i class="fas fa-link"></i> Recommended Sources:</h6>
            <div class="sources-grid">
              {% for source in guide.information_sources %}
              <div class="source-item">
                <div class="source-header">
                  <strong>{{ source.source_name }}</strong>
                  <span class="source-type">{{ source.source_type.value.title() }}</span>
                </div>
                <p class="source-description">{{ source.description }}</p>
                {% if source.url %}
                <a href="{{ source.url }}" target="_blank" class="source-link">
                  <i class="fas fa-external-link-alt"></i> Visit Source
                </a>
                {% endif %}
                {% if source.search_tips %}
                <div class="search-tips">
                  <small><strong>Search Tips:</strong> {{ source.search_tips }}</small>
                </div>
                {% endif %}
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}
          
          {% if guide.expected_outcomes %}
          <div class="expected-outcomes">
            <h6><i class="fas fa-bullseye"></i> Expected Learning Outcomes:</h6>
            <ul>
              {% for outcome in guide.expected_outcomes %}
              <li>{{ outcome }}</li>
              {% endfor %}
            </ul>
          </div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
      {% endif %}
    </div>
    {% endif %}

    <!-- Community Insights Section -->
    {% if not error %}
    <div class="community-section">
      <h2 class="community-header">
        <i class="fas fa-users"></i> Community Insights for {{ company_name }}
      </h2>

      <!-- Contribution Form -->
      <div class="contribute-form">
        <h4><i class="fas fa-plus-circle"></i> Share Your Analysis</h4>
        <form id="contribute-form">
          <div class="form-group">
            <label for="insight-category">Analysis Type:</label>
            <select id="insight-category" required>
              <option value="">Select category...</option>
              <option value="moat_analysis">Moat Analysis</option>
              <option value="management">Management Assessment</option>
              <option value="competitive_analysis">Competitive Analysis</option>
              <option value="industry_analysis">Industry Analysis</option>
            </select>
          </div>
          <div class="form-group">
            <label for="insight-content">Your Analysis:</label>
            <textarea
              id="insight-content"
              placeholder="Share your insights about {{ company_name }}. What makes this company unique? How is the management? What competitive advantages do they have?"
              required
              minlength="10"
              maxlength="2000"
            >
            </textarea>
            <small
              >10-2000 characters. Be specific and helpful to other
              investors.</small
            >
          </div>
          <button type="submit" class="submit-btn">
            <i class="fas fa-share"></i> Share Insight
          </button>
        </form>
      </div>

      <!-- Existing Insights -->
      <div id="insights-container">
        {% if community_insights %} {% for insight in community_insights %}
        <div class="insight-card" data-insight-id="{{ insight.id }}">
          <div class="insight-header">
            <span class="insight-category"
              >{{ insight.category.value.replace('_', ' ').title() }}</span
            >
            <span class="insight-date"
              >{{ insight.created_at.strftime('%Y-%m-%d') }}</span
            >
          </div>
          <div class="insight-content">{{ insight.content }}</div>
          <div class="insight-actions">
            <div class="vote-buttons">
              <button
                class="vote-btn up"
                data-insight-id="{{ insight.id }}"
                data-vote-type="up"
              >
                <i class="fas fa-thumbs-up"></i> {{ insight.votes_up }}
              </button>
              <button
                class="vote-btn down"
                data-insight-id="{{ insight.id }}"
                data-vote-type="down"
              >
                <i class="fas fa-thumbs-down"></i> {{ insight.votes_down }}
              </button>
            </div>
            <button class="flag-btn" data-insight-id="{{ insight.id }}">
              <i class="fas fa-flag"></i> Flag
            </button>
          </div>
        </div>
        {% endfor %} {% else %}
        <div class="no-insights">
          <i class="fas fa-lightbulb"></i>
          <p>No community insights yet for {{ company_name }}.</p>
          <p>Be the first to share your analysis!</p>
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}
    <!-- jQuery and Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
      $(document).ready(function () {
        $("#another-ticker-input").on("input", function () {
          let query = $(this).val();
          if (query.length > 1) {
            $.get("/suggest", { query: query }, function (data) {
              $("#suggestions-list").empty();
              $.each(data.suggestions, function (name, ticker) {
                $("#suggestions-list").append(
                  `<li data-ticker="${ticker}">${name} (${ticker})</li>`
                );
              });
            });
          } else {
            $("#suggestions-list").empty();
          }
        });

        $(document).on("click", "#suggestions-list li", function () {
          $("#another-ticker-input").val($(this).data("ticker"));
          $("#suggestions-list").empty();
          $("form").submit();
        });

        $(".data td").each(function () {
          let value = parseFloat($(this).text());
          if (!isNaN(value)) {
            if ($(this).index() === 0) {
              $(this).text(Math.round(value));
            } else {
              if (value > 0) {
                $(this).addClass("positive");
              } else if (value < 0) {
                $(this).addClass("negative");
              }
              $(this).text(value.toFixed(2));
            }
          }
        });

        // Community Features JavaScript

        // Handle insight contribution
        $("#contribute-form").on("submit", function (e) {
          e.preventDefault();

          const category = $("#insight-category").val();
          const content = $("#insight-content").val().trim();
          const ticker = "{{ ticker }}";

          if (!category || !content) {
            alert("Please fill in all fields");
            return;
          }

          $.ajax({
            url: "/community/contribute",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({
              ticker: ticker,
              category: category,
              content: content,
            }),
            success: function (response) {
              if (response.success) {
                alert("Thank you for your contribution!");
                location.reload(); // Reload to show new insight
              } else {
                alert("Error: " + response.message);
              }
            },
            error: function () {
              alert("Error submitting insight. Please try again.");
            },
          });
        });

        // Handle voting
        $(".vote-btn").on("click", function () {
          const insightId = $(this).data("insight-id");
          const voteType = $(this).data("vote-type");
          const button = $(this);

          $.ajax({
            url: "/community/vote",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({
              insight_id: insightId,
              vote_type: voteType,
            }),
            success: function (response) {
              if (response.success) {
                // Reload to show updated vote counts
                location.reload();
              } else {
                alert("Error: " + response.message);
              }
            },
            error: function () {
              alert("Error recording vote. Please try again.");
            },
          });
        });

        // Handle flagging
        $(".flag-btn").on("click", function () {
          if (
            !confirm(
              "Are you sure you want to flag this insight as inappropriate?"
            )
          ) {
            return;
          }

          const insightId = $(this).data("insight-id");

          $.ajax({
            url: "/community/flag",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({
              insight_id: insightId,
            }),
            success: function (response) {
              if (response.success) {
                alert("Insight flagged for review.");
                location.reload();
              } else {
                alert("Error: " + response.message);
              }
            },
            error: function () {
              alert("Error flagging insight. Please try again.");
            },
          });
        });
      });
      document.addEventListener("DOMContentLoaded", function () {
        const infoButtons = document.querySelectorAll(".info-button");

        infoButtons.forEach((button) => {
          button.addEventListener("click", function () {
            const explanation = this.getAttribute("data-explanation");
            alert(explanation); // Show explanation in an alert box
          });
        });
      });
    </script>
  </body>
</html>
