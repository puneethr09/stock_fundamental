<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ ticker }} - Dorsey Analysis | Stock Fundamental</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/premium.css') }}">
</head>
<body>

<!-- Fixed Home Button -->
<a href="{{ url_for('home') }}" class="home-nav" title="Go to Home">
    <i class="fas fa-home"></i>
</a>

<div class="container mt-4 mb-5">
    {% if error %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-circle mr-2"></i>
        <strong>Error:</strong> {{ error }}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    {% endif %}

    <!-- ============================================================ -->
    <!-- HEADER WITH SEARCH -->
    <!-- ============================================================ -->
    <div class="d-flex justify-content-between align-items-center flex-wrap mb-4">
        <div class="mb-2 mb-md-0">
            <span class="badge badge-secondary mb-2">{{ sector_analysis.sector }}</span>
            <h1 class="mb-0" style="font-size: 1.8rem;">{{ company_name }} <small class="text-muted" style="font-size: 0.5em;">{{ ticker }}</small></h1>
        </div>
        <form action="/analyze" method="POST" class="position-relative" autocomplete="off" style="min-width: 250px;">
            <div class="input-group">
                <input id="ticker-input" type="text" name="ticker" class="form-control" placeholder="Search ticker..." required>
                <div class="input-group-append">
                    <button class="btn btn-primary" type="submit"><i class="fas fa-search"></i></button>
                </div>
            </div>
            <ul id="suggestions-list" class="list-group position-absolute w-100" style="top: 100%; z-index: 2000; max-height: 300px; overflow-y: auto;"></ul>
        </form>
    </div>

    <!-- ============================================================ -->
    <!-- DORSEY SCORECARD - THE VERDICT -->
    <!-- ============================================================ -->
    {% if scorecard %}
    <div class="card mb-4 animate-fade-in {% if scorecard.recommendation == 'STRONG BUY' %}border-glow-green{% elif 'AVOID' in scorecard.recommendation %}border-glow-red{% else %}glow-blue{% endif %}" style="border-width: 2px;">
        <div class="card-body py-4">
            <div class="row align-items-center">
                <!-- Score Circle -->
                <div class="col-md-2 text-center mb-3 mb-md-0">
                    <div class="score-circle {% if scorecard.total_score >= 60 %}{% elif scorecard.total_score >= 40 %}moderate{% else %}poor{% endif %}">
                        <div class="text-center">
                            <span style="font-size: 2rem; font-weight: 800; line-height: 1;">{{ scorecard.total_score|round|int }}</span>
                            <span class="d-block text-muted" style="font-size: 0.8rem;">/100</span>
                        </div>
                    </div>
                    <p class="mt-2 mb-0 small text-muted">
                        <span class="info-tooltip tooltip-bottom">Dorsey Score
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-content">
                                <span class="tooltip-title"><i class="fas fa-star"></i> Dorsey Score</span>
                                <span class="tooltip-text">A composite score from 0-100 based on Pat Dorsey's Five Rules framework. Combines Ten-Minute Test, Moat Analysis, Financial Health, and Valuation.</span>
                                <span class="tooltip-benchmark">
                                    <span class="benchmark-good">75+: Strong Buy</span> |
                                    <span class="benchmark-bad">&lt;40: Avoid</span>
                                </span>
                            </span>
                        </span>
                    </p>
                </div>
                
                <!-- Recommendation -->
                <div class="col-md-3 text-center mb-3 mb-md-0">
                    <h2 class="mb-1 {% if scorecard.recommendation == 'STRONG BUY' %}text-success{% elif scorecard.recommendation == 'BUY' %}text-info{% elif 'AVOID' in scorecard.recommendation %}text-danger{% else %}text-warning{% endif %}">
                        {{ scorecard.recommendation }}
                    </h2>
                    <small class="text-muted">Confidence: {{ scorecard.confidence }}</small>
                </div>
                
                <!-- Component Breakdown -->
                <div class="col-md-7">
                    <div class="row">
                        <div class="col-6 col-lg-3 mb-2">
                            <div class="metric-card text-center">
                                <div class="metric-label">
                                    <span class="info-tooltip tooltip-bottom">10-Min Test
                                        <span class="tooltip-icon">?</span>
                                        <span class="tooltip-content">
                                            <span class="tooltip-title"><i class="fas fa-clock"></i> Ten-Minute Test</span>
                                            <span class="tooltip-text">Quick quality filter from Chapter 12. Checks operating profit, FCF, ROE, debt levels, and earnings consistency.</span>
                                        </span>
                                    </span>
                                </div>
                                <div class="metric-value">{{ scorecard.scores.ten_minute_test.score|round|int }}<span class="text-muted" style="font-size:0.8rem">/{{ scorecard.scores.ten_minute_test.max }}</span></div>
                            </div>
                        </div>
                        <div class="col-6 col-lg-3 mb-2">
                            <div class="metric-card text-center">
                                <div class="metric-label">
                                    <span class="info-tooltip tooltip-bottom">Moat
                                        <span class="tooltip-icon">?</span>
                                        <span class="tooltip-content">
                                            <span class="tooltip-title"><i class="fas fa-shield-alt"></i> Economic Moat</span>
                                            <span class="tooltip-text">A durable competitive advantage that protects profits. Wide moats come from: intangible assets, switching costs, network effects, or cost advantages.</span>
                                            <div class="tooltip-formula">ROIC > 15% for 10+ years = Wide Moat</div>
                                        </span>
                                    </span>
                                </div>
                                <div class="metric-value">{{ scorecard.scores.moat.score }}<span class="text-muted" style="font-size:0.8rem">/{{ scorecard.scores.moat.max }}</span></div>
                            </div>
                        </div>
                        <div class="col-6 col-lg-3 mb-2">
                            <div class="metric-card text-center">
                                <div class="metric-label">
                                    <span class="info-tooltip tooltip-bottom">Health
                                        <span class="tooltip-icon">?</span>
                                        <span class="tooltip-content">
                                            <span class="tooltip-title"><i class="fas fa-heartbeat"></i> Financial Health</span>
                                            <span class="tooltip-text">Balance sheet strength and red flag detection. Checks interest coverage, CFO quality, inventory/receivables bloat from Chapter 8.</span>
                                        </span>
                                    </span>
                                </div>
                                <div class="metric-value">{{ scorecard.scores.financial_health.score }}<span class="text-muted" style="font-size:0.8rem">/{{ scorecard.scores.financial_health.max }}</span></div>
                            </div>
                        </div>
                        <div class="col-6 col-lg-3 mb-2">
                            <div class="metric-card text-center">
                                <div class="metric-label">
                                    <span class="info-tooltip tooltip-bottom">Value
                                        <span class="tooltip-icon">?</span>
                                        <span class="tooltip-content">
                                            <span class="tooltip-title"><i class="fas fa-tags"></i> Valuation</span>
                                            <span class="tooltip-text">Price vs intrinsic value using DCF or sector-appropriate model. Margin of Safety protects against estimation errors.</span>
                                            <div class="tooltip-benchmark">
                                                <span class="benchmark-good">30%+ MoS: Undervalued</span>
                                            </div>
                                        </span>
                                    </span>
                                </div>
                                <div class="metric-value">{{ scorecard.scores.valuation.score }}<span class="text-muted" style="font-size:0.8rem">/{{ scorecard.scores.valuation.max }}</span></div>
                            </div>
                        </div>
                    </div>
                    {% if scorecard.summary %}
                    <p class="text-muted small mt-3 mb-0"><i class="fas fa-lightbulb text-warning mr-2"></i>{{ scorecard.summary }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ============================================================ -->
    <!-- GRAHAM ANALYSIS - INTELLIGENT INVESTOR -->
    <!-- ============================================================ -->
    {% if graham_analysis and graham_analysis.graham_number %}
    <div class="card mb-4 animate-fade-in" style="animation-delay: 0.1s;">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-book text-info mr-2"></i>Graham Analysis
                <span class="info-tooltip">
                    <span class="tooltip-icon">?</span>
                    <span class="tooltip-content">
                        <span class="tooltip-title"><i class="fas fa-user-tie"></i> Benjamin Graham</span>
                        <span class="tooltip-text">Value investing principles from "The Intelligent Investor" - considered the bible of value investing. Graham was Warren Buffett's mentor.</span>
                    </span>
                </span>
            </h5>
            <span class="badge badge-secondary">Intelligent Investor</span>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Graham Number -->
                <div class="col-md-4 text-center mb-3 mb-md-0">
                    <div class="metric-card h-100">
                        <div class="metric-label">
                            <span class="info-tooltip">Graham Number
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-content">
                                    <span class="tooltip-title"><i class="fas fa-calculator"></i> Graham Number</span>
                                    <span class="tooltip-text">Maximum price for a defensive investor. Stock trading below this has margin of safety.</span>
                                    <div class="tooltip-formula">√(22.5 × EPS × BVPS)</div>
                                </span>
                            </span>
                        </div>
                        {% if graham_analysis.graham_number.value %}
                        <div class="metric-value text-info">₹{{ graham_analysis.graham_number.value|round|int }}</div>
                        <span class="metric-status {% if graham_analysis.graham_number.verdict == 'Undervalued' %}pass{% elif graham_analysis.graham_number.verdict == 'Overvalued' %}fail{% else %}warn{% endif %}">
                            {{ graham_analysis.graham_number.verdict }}
                        </span>
                        {% else %}
                        <div class="metric-value text-muted">N/A</div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Graham Intrinsic Value -->
                <div class="col-md-4 text-center mb-3 mb-md-0">
                    <div class="metric-card h-100">
                        <div class="metric-label">
                            <span class="info-tooltip">Intrinsic Value
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-content">
                                    <span class="tooltip-title"><i class="fas fa-gem"></i> Graham Intrinsic Value</span>
                                    <span class="tooltip-text">1974 revised formula accounting for bond yields and growth.</span>
                                    <div class="tooltip-formula">V = EPS × (8.5 + 2g) × 4.4/Y</div>
                                </span>
                            </span>
                        </div>
                        {% if graham_analysis.intrinsic_value.revised_formula_value %}
                        <div class="metric-value text-info">₹{{ graham_analysis.intrinsic_value.revised_formula_value|round|int }}</div>
                        <span class="metric-status {% if graham_analysis.intrinsic_value.verdict == 'Buy' %}pass{% elif graham_analysis.intrinsic_value.verdict == 'Avoid' %}fail{% else %}warn{% endif %}">
                            {{ graham_analysis.intrinsic_value.verdict }}
                        </span>
                        {% else %}
                        <div class="metric-value text-muted">N/A</div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Defensive Screen -->
                <div class="col-md-4 text-center">
                    <div class="metric-card h-100">
                        <div class="metric-label">
                            <span class="info-tooltip">Defensive Criteria
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-content">
                                    <span class="tooltip-title"><i class="fas fa-shield-alt"></i> Defensive Investor</span>
                                    <span class="tooltip-text">7 criteria for conservative investors: adequate size, financial condition, earnings stability, dividend record, earnings growth, moderate P/E, moderate P/B.</span>
                                    <div class="tooltip-benchmark">
                                        <span class="benchmark-good">6-7: Strong Candidate</span>
                                    </div>
                                </span>
                            </span>
                        </div>
                        {% if graham_defensive_screen %}
                        <div class="metric-value {% if graham_defensive_screen.passed >= 5 %}text-success{% elif graham_defensive_screen.passed >= 3 %}text-warning{% else %}text-danger{% endif %}">
                            {{ graham_defensive_screen.passed }}/{{ graham_defensive_screen.total }}
                        </div>
                        <span class="metric-status {% if graham_defensive_screen.passed >= 5 %}pass{% elif graham_defensive_screen.passed >= 3 %}warn{% else %}fail{% endif %}">
                            {{ graham_defensive_screen.verdict }}
                        </span>
                        {% else %}
                        <div class="metric-value text-muted">N/A</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            {% if graham_analysis.mr_market %}
            <div class="text-center mt-3 pt-3" style="border-top: 1px solid rgba(255,255,255,0.1);">
                <small class="text-muted mr-2">Mr. Market Mood:</small>
                <span class="badge {% if graham_analysis.mr_market.mr_market_mood == 'Pessimistic' %}badge-success{% elif graham_analysis.mr_market.mr_market_mood == 'Euphoric' %}badge-danger{% else %}badge-secondary{% endif %}">
                    {{ graham_analysis.mr_market.mr_market_mood }}
                </span>
                <small class="text-muted ml-2">(P/E: {{ graham_analysis.mr_market.current_pe }})</small>
                <span class="info-tooltip ml-2">
                    <span class="tooltip-icon" style="width:16px; height:16px; font-size:10px;">?</span>
                    <span class="tooltip-content" style="width: 280px;">
                        <span class="tooltip-title"><i class="fas fa-theater-masks"></i> Mr. Market</span>
                        <span class="tooltip-text">Graham's allegory: treat the market as a manic-depressive partner. When euphoric, sell; when pessimistic, buy.</span>
                    </span>
                </span>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- ============================================================ -->
    <!-- MISTAKE WARNINGS -->
    <!-- ============================================================ -->
    {% if mistake_warnings and mistake_warnings.mistake_warnings|length > 0 %}
    <div class="alert alert-warning mb-4 animate-fade-in" style="animation-delay: 0.15s;">
        <h5 class="mb-3"><i class="fas fa-exclamation-triangle mr-2"></i>Dorsey Warning Signs
            <span class="info-tooltip">
                <span class="tooltip-icon" style="background: rgba(245, 158, 11, 0.3); color: #f59e0b;">?</span>
                <span class="tooltip-content">
                    <span class="tooltip-title"><i class="fas fa-user-times"></i> Seven Mistakes to Avoid</span>
                    <span class="tooltip-text">From Chapter 2: Common investor mistakes including ignoring valuation and relying only on earnings without verifying cash flow.</span>
                </span>
            </span>
        </h5>
        <ul class="mb-0 pl-4">
            {% for warning in mistake_warnings.mistake_warnings %}
            <li class="mb-2">
                <strong>{{ warning.mistake }}:</strong> {{ warning.indicator }}
                <br><small class="text-muted">{{ warning.dorsey_says }}</small>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- ============================================================ -->
    <!-- TEN-MINUTE TEST -->
    <!-- ============================================================ -->
    <div class="card mb-4 animate-fade-in" style="animation-delay: 0.2s; border-color: {% if ten_minute_test.passed %}rgba(34, 197, 94, 0.5){% else %}rgba(239, 68, 68, 0.5){% endif %};">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-stopwatch text-warning mr-2"></i>Ten-Minute Test
                <span class="info-tooltip">
                    <span class="tooltip-icon">?</span>
                    <span class="tooltip-content">
                        <span class="tooltip-title"><i class="fas fa-filter"></i> Chapter 12: Ten-Minute Test</span>
                        <span class="tooltip-text">Quick quality filter to weed out stocks not worth deeper analysis. Checks for profitability, cash flow, debt levels, and basic financial health.</span>
                    </span>
                </span>
            </h5>
            <span class="badge {% if ten_minute_test.passed %}badge-success{% else %}badge-danger{% endif %} p-2" style="font-size: 1rem;">
                {{ ten_minute_test.overall_verdict }}
            </span>
        </div>
        <div class="card-body">
            <div class="row">
                {% for item in ten_minute_test.checklist %}
                <div class="col-md-3 col-6 mb-3">
                    <div class="metric-card h-100">
                        <div class="metric-label">{{ item.name }}</div>
                        <div class="metric-value" style="font-size: 1.2rem;">{{ item.value }}</div>
                        <span class="metric-status {% if item.status == 'PASS' %}pass{% elif item.status == 'FAIL' %}fail{% else %}warn{% endif %}">
                            {{ item.status }}
                        </span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- ============================================================ -->
    <!-- CORE ANALYSIS ROW -->
    <!-- ============================================================ -->
    <div class="row">
        <!-- MOAT -->
        <div class="col-lg-4 mb-4">
            <div class="card h-100 animate-fade-in" style="animation-delay: 0.25s;">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-shield-alt text-primary mr-2"></i>Economic Moat
                        <span class="info-tooltip">
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-content">
                                <span class="tooltip-title"><i class="fas fa-castle"></i> Chapter 3: Economic Moats</span>
                                <span class="tooltip-text">A structural advantage that protects profits from competition. Sources: intangible assets (brands, patents), switching costs, network effects, cost advantages.</span>
                                <div class="tooltip-formula">Wide Moat = ROIC > 15% sustained</div>
                            </span>
                        </span>
                    </h5>
                </div>
                <div class="card-body text-center">
                    <h2 class="mb-3 {% if 'Wide' in moat_analysis.moat_rating %}text-success{% elif 'Narrow' in moat_analysis.moat_rating %}text-info{% else %}text-muted{% endif %}">
                        {{ moat_analysis.moat_rating }}
                    </h2>
                    
                    {% for d in moat_analysis.details %}
                    <div class="d-flex justify-content-between align-items-center py-2" style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                        <span class="text-muted small">
                            <span class="info-tooltip">{{ d.metric }}
                                <span class="tooltip-icon" style="width:14px; height:14px; font-size:9px;">?</span>
                                <span class="tooltip-content" style="width: 240px;">
                                    <span class="tooltip-title">{{ d.metric }}</span>
                                    <span class="tooltip-text">{{ d.comment }}</span>
                                </span>
                            </span>
                        </span>
                        <span class="font-weight-bold">{{ d.value }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- VALUATION -->
        <div class="col-lg-4 mb-4">
            <div class="card h-100 animate-fade-in" style="animation-delay: 0.3s;">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-tags text-success mr-2"></i>Intrinsic Value
                        <span class="info-tooltip">
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-content">
                                <span class="tooltip-title"><i class="fas fa-calculator"></i> AlphaSpread Method</span>
                                <span class="tooltip-text">Combines DCF (40%) + Relative Valuation (60%) for a balanced, market-realistic intrinsic value estimate.</span>
                            </span>
                        </span>
                    </h5>
                </div>
                <div class="card-body">
                    {% if valuation.combined %}
                    <!-- Combined Intrinsic Value (AlphaSpread-like) -->
                    <div class="text-center mb-3">
                        <small class="text-muted d-block">Combined Intrinsic Value</small>
                        <h2 class="text-info mb-1">₹{{ "%.0f"|format(valuation.combined.combined_value) }}</h2>
                        <span class="badge {% if valuation.combined.verdict == 'UNDERVALUED' %}badge-success{% elif valuation.combined.verdict == 'OVERVALUED' %}badge-danger{% else %}badge-warning{% endif %}">
                            {{ valuation.combined.verdict }}
                        </span>
                    </div>
                    
                    <!-- DCF vs Relative breakdown -->
                    <div class="row text-center mb-3">
                        <div class="col-6">
                            <div class="metric-card py-2">
                                <small class="text-muted d-block">DCF Value</small>
                                <h5 class="text-warning mb-0">
                                    {% if valuation.combined.dcf_value %}₹{{ "%.0f"|format(valuation.combined.dcf_value) }}{% else %}N/A{% endif %}
                                </h5>
                                <small class="text-muted" style="font-size:0.7rem;">40% weight</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="metric-card py-2">
                                <small class="text-muted d-block">Relative Value</small>
                                <h5 class="text-success mb-0">
                                    {% if valuation.combined.relative_value %}₹{{ "%.0f"|format(valuation.combined.relative_value) }}{% else %}N/A{% endif %}
                                </h5>
                                <small class="text-muted" style="font-size:0.7rem;">60% weight</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Relative methods used -->
                    {% if valuation.combined.relative_methods %}
                    <div class="text-center mb-2" style="font-size:0.75rem;">
                        {% for method in valuation.combined.relative_methods %}
                        <span class="badge badge-secondary mr-1 mb-1">{{ method }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <!-- Current Price & Margin -->
                    <div class="text-center py-2" style="background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <small class="text-muted d-block">Current Price</small>
                        <h5 class="mb-1">₹{{ valuation.current_price }}</h5>
                        {% if valuation.combined.margin_of_safety > 0 %}
                        <span class="badge badge-success">
                            <i class="fas fa-arrow-down mr-1"></i>{{ "%.0f"|format(valuation.combined.margin_of_safety) }}% Undervalued
                        </span>
                        {% else %}
                        <span class="badge badge-danger">
                            <i class="fas fa-arrow-up mr-1"></i>{{ "%.0f"|format(valuation.combined.margin_of_safety * -1) }}% Premium
                        </span>
                        {% endif %}
                    </div>
                    
                    {% else %}
                    <!-- Fallback: Old DCF-only display -->
                    <div class="text-center mb-3">
                        <small class="text-muted text-uppercase">{{ valuation.model_type }} Model</small>
                    </div>
                    <div class="row text-center mb-3">
                        <div class="col-4">
                            <small class="text-muted d-block">Conservative</small>
                            <h5 class="text-warning mb-0">₹{{ "%.0f"|format(valuation.scenarios.Conservative.value) }}</h5>
                        </div>
                        <div class="col-4">
                            <small class="text-info font-weight-bold d-block">Base Case</small>
                            <h4 class="text-info mb-0">₹{{ "%.0f"|format(valuation.intrinsic_value) }}</h4>
                        </div>
                        <div class="col-4">
                            <small class="text-muted d-block">Optimistic</small>
                            <h5 class="text-success mb-0">₹{{ "%.0f"|format(valuation.scenarios.Optimistic.value) }}</h5>
                        </div>
                    </div>
                    <div class="text-center py-3" style="background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <small class="text-muted d-block">Current Price</small>
                        <h5 class="mb-2">₹{{ valuation.current_price }}</h5>
                        {% if valuation.margin_of_safety > 0 %}
                        <span class="badge badge-success">
                            <i class="fas fa-arrow-down mr-1"></i>{{ "%.0f"|format(valuation.margin_of_safety) }}% Margin of Safety
                        </span>
                        {% else %}
                        <span class="badge badge-danger">
                            <i class="fas fa-arrow-up mr-1"></i>{{ "%.0f"|format(valuation.margin_of_safety * -1) }}% Premium
                        </span>
                        {% endif %}
                    </div>
                    <div class="mt-3 text-center">
                        <span class="badge {% if 'BUY' in valuation.verdict %}badge-success{% elif 'SELL' in valuation.verdict %}badge-danger{% else %}badge-warning{% endif %} p-2">
                            {{ valuation.verdict }}
                        </span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- FINANCIAL HEALTH -->
        <div class="col-lg-4 mb-4">
            <div class="card h-100 animate-fade-in" style="animation-delay: 0.35s;">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-heartbeat text-danger mr-2"></i>Financial Health
                        <span class="info-tooltip">
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-content">
                                <span class="tooltip-title"><i class="fas fa-stethoscope"></i> Chapters 5-8: Financial Statements</span>
                                <span class="tooltip-text">Balance sheet strength and red flag detection. Checks for accounting tricks, inventory bloat, receivables manipulation.</span>
                            </span>
                        </span>
                    </h5>
                </div>
                <div class="card-body">
                    <h3 class="text-center mb-3 {% if financial_health.health_rating == 'ROBUST' %}text-success{% elif financial_health.health_rating == 'RISKY' %}text-danger{% else %}text-warning{% endif %}">
                        {{ financial_health.health_rating }}
                    </h3>
                    
                    {% if financial_health.red_flags %}
                    <div class="alert alert-danger py-2 px-3 mb-3">
                        <small><i class="fas fa-exclamation-triangle mr-1"></i>Red Flags:</small>
                        <ul class="mb-0 pl-3 small">
                            {% for flag in financial_health.red_flags %}
                            <li>{{ flag }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% else %}
                    <div class="alert alert-success py-2 px-3 mb-3">
                        <small><i class="fas fa-check-circle mr-1"></i>No red flags detected</small>
                    </div>
                    {% endif %}
                    
                    {% for c in financial_health.checks %}
                    <div class="d-flex justify-content-between py-2" style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                        <span class="small">{{ c.metric }}</span>
                        <span class="small">
                            {{ c.value }}
                            <span class="badge badge-sm {% if c.status == 'PASS' %}badge-success{% elif c.status == 'OK' %}badge-secondary{% else %}badge-warning{% endif %} ml-1">{{ c.status }}</span>
                        </span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================================ -->
    <!-- SECTOR ANALYSIS -->
    <!-- ============================================================ -->
    <div class="section-header">
        <i class="fas fa-industry text-info"></i>
        <h3>{{ sector_analysis.sector }} Sector Analysis
            <span class="info-tooltip">
                <span class="tooltip-icon">?</span>
                <span class="tooltip-content">
                    <span class="tooltip-title"><i class="fas fa-chart-pie"></i> {{ sector_analysis.chapter_reference | default('Sector Guide') }}</span>
                    <span class="tooltip-text">Industry-specific metrics and analysis. Different sectors have different key success factors and valuation methodologies.</span>
                </span>
            </span>
        </h3>
    </div>
    
    <div class="card mb-4 animate-fade-in" style="animation-delay: 0.4s;">
        <div class="card-body">
            <div class="row">
                {% for insight in sector_analysis.insights %}
                <div class="col-md-4 col-6 mb-3">
                    <div class="metric-card h-100">
                        <div class="metric-label">
                            <span class="info-tooltip">{{ insight.metric }}
                                <span class="tooltip-icon" style="width:14px; height:14px; font-size:9px;">?</span>
                                <span class="tooltip-content" style="width: 280px;">
                                    <span class="tooltip-title">{{ insight.metric }}</span>
                                    <span class="tooltip-text">{{ insight.context }}</span>
                                    {% if insight.benchmark %}
                                    <div class="tooltip-benchmark">{{ insight.benchmark }}</div>
                                    {% endif %}
                                </span>
                            </span>
                        </div>
                        <div class="metric-value" style="font-size: 1.3rem;">{{ insight.value }}</div>
                        <span class="badge badge-secondary mt-2">{{ insight.judgment }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            {% if sector_analysis.dorsey_wisdom %}
            <div class="mt-3 p-3" style="background: rgba(56, 189, 248, 0.1); border-radius: 8px; border-left: 3px solid var(--accent-blue);">
                <small class="text-info"><i class="fas fa-quote-left mr-2"></i>{{ sector_analysis.dorsey_wisdom }}</small>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ============================================================ -->
    <!-- EDUCATIONAL FOOTER -->
    <!-- ============================================================ -->
    <div class="card mb-4 animate-fade-in" style="animation-delay: 0.45s;">
        <div class="card-header" style="cursor: pointer;" data-toggle="collapse" data-target="#educationalContent">
            <h5 class="mb-0 d-flex justify-content-between align-items-center">
                <span><i class="fas fa-graduation-cap text-purple mr-2"></i>Learn the Framework</span>
                <i class="fas fa-chevron-down text-muted"></i>
            </h5>
        </div>
        <div id="educationalContent" class="collapse">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <h6 class="text-info"><i class="fas fa-filter mr-2"></i>Ten-Minute Test (Ch 12)</h6>
                        <p class="small text-muted">Quick quality filter. Checks: operating profit history, FCF generation, ROE >15%, manageable debt. Pass this first before deeper analysis.</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <h6 class="text-info"><i class="fas fa-castle mr-2"></i>Economic Moats (Ch 3)</h6>
                        <p class="small text-muted">Sustainable competitive advantage. ROIC >15% for 10+ years is evidence. Sources: brands, patents, switching costs, network effects, scale.</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <h6 class="text-info"><i class="fas fa-calculator mr-2"></i>Valuation (Ch 9-10)</h6>
                        <p class="small text-muted">Never overpay. Use DCF or Graham formulas. Always demand 30%+ Margin of Safety - buffer against errors in estimates.</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <h6 class="text-info"><i class="fas fa-user-secret mr-2"></i>Financial Fakery (Ch 8)</h6>
                        <p class="small text-muted">Watch for: CFO < Net Income, inventory growing faster than sales, receivables bloat. Cash flow doesn't lie.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Search Auto-Complete -->
<script>
    const input = document.getElementById("ticker-input");
    const suggestions = document.getElementById("suggestions-list");
    let timeout = null;

    input.addEventListener("input", (e) => {
        clearTimeout(timeout);
        const q = e.target.value.trim();
        if (!q || q.length < 2) {
            suggestions.innerHTML = "";
            return;
        }
        timeout = setTimeout(async () => {
            try {
                const res = await fetch(`/suggest?query=${encodeURIComponent(q)}`);
                const data = await res.json();
                suggestions.innerHTML = "";
                const raw = data.suggestions;

                if (raw) {
                    const makeLi = (text, ticker) => {
                        const li = document.createElement("li");
                        li.className = "list-group-item list-group-item-action";
                        li.style.cssText = "cursor: pointer; background: rgba(30,41,59,0.95); color: #f8fafc; border-color: rgba(255,255,255,0.1);";
                        li.textContent = text;
                        li.addEventListener("click", () => {
                            input.value = ticker;
                            suggestions.innerHTML = "";
                            input.closest('form').submit(); 
                        });
                        return li;
                    };

                    if (Array.isArray(raw)) {
                        raw.forEach(s => suggestions.appendChild(makeLi(`${s.name} (${s.ticker})`, s.ticker)));
                    } else if (typeof raw === "object") {
                        Object.keys(raw).forEach(name => suggestions.appendChild(makeLi(`${name} (${raw[name]})`, raw[name])));
                    }
                }
            } catch (err) {
                console.warn("Suggestion fetch failed", err);
            }
        }, 300);
    });

    document.addEventListener("click", (e) => {
        if (!input.contains(e.target) && !suggestions.contains(e.target)) {
            suggestions.innerHTML = "";
        }
    });

    // Tooltip functionality
    document.querySelectorAll('.info-tooltip').forEach(tooltip => {
        const content = tooltip.querySelector('.tooltip-content');
        if (content) {
            // Hide by default
            content.style.opacity = '0';
            content.style.visibility = 'hidden';
            content.style.pointerEvents = 'none';
            
            tooltip.addEventListener('mouseenter', () => {
                content.style.opacity = '1';
                content.style.visibility = 'visible';
                content.style.pointerEvents = 'auto';
                content.style.transform = 'translateX(-50%) translateY(0)';
            });
            
            tooltip.addEventListener('mouseleave', () => {
                content.style.opacity = '0';
                content.style.visibility = 'hidden';
                content.style.pointerEvents = 'none';
                content.style.transform = 'translateX(-50%) translateY(10px)';
            });
        }
    });
</script>

</body>
</html>
