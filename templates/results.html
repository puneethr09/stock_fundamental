
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ ticker }} - Dorsey Analysis</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/premium.css') }}">
    <style>
        /* Custom Overrides for Dorsey Theme */
        .verdict-pass { color: #28a745; font-weight: bold; }
        .verdict-fail { color: #dc3545; font-weight: bold; }
        .verdict-neutral { color: #ffc107; font-weight: bold; }
        .card-header-dorsey { background: rgba(255, 255, 255, 0.05); border-bottom: 1px solid rgba(255,255,255,0.1); }
        .section-title { margin-top: 30px; margin-bottom: 15px; border-left: 4px solid #007bff; padding-left: 10px; color: #fff; }
    </style>
</head>
<body class="bg-dark text-light">

<div class="container mt-4">
    {% if error %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <strong>Error:</strong> {{ error }}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    {% endif %}

    <!-- Header with Embedded Search -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="display-4">{{ company_name }} <small class="text-muted" style="font-size: 0.5em;">{{ ticker }}</small></h1>
            <p class="lead text-muted">{{ sector_analysis.sector }} Strategy (Chapter 21)</p>
        </div>
        <div class="text-right">
            <form action="/analyze" method="POST" class="form-inline position-relative" autocomplete="off">
                <div class="input-group">
                    <input id="ticker-input" type="text" name="ticker" class="form-control bg-dark text-light border-secondary" placeholder="Ticker (e.g. TCS)" required>
                    <div class="input-group-append">
                        <button class="btn btn-outline-primary" type="submit"><i class="fas fa-search"></i></button>
                    </div>
                </div>
                <ul id="suggestions-list" class="list-group position-absolute w-100" style="top: 100%; z-index: 2000; max-height: 300px; overflow-y: auto;"></ul>
            </form>
        </div>
    </div>

    <!-- 1. The 10-Minute Test Verdict (Ch 12) -->
    <div class="card shadow-lg mb-4" style="border: 2px solid {% if ten_minute_test.passed %}#28a745{% else %}#dc3545{% endif %};">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0">The 10-Minute Test (Filters)</h4>
            <span class="badge badge-pill {% if ten_minute_test.passed %}badge-success{% else %}badge-danger{% endif %} p-2" style="font-size: 1.2em;">
                VERDICT: {{ ten_minute_test.overall_verdict }}
            </span>
        </div>
        <div class="card-body">
            <div class="row">
                {% for item in ten_minute_test.checklist %}
                <div class="col-md-3 mb-2">
                    <div class="p-2 rounded" style="background: rgba(255,255,255,0.05);">
                        <small class="text-muted d-block">{{ item.name }}</small>
                        <strong class="{% if item.status == 'PASS' %}text-success{% elif item.status == 'FAIL' %}text-danger{% else %}text-warning{% endif %}" style="font-size: 1.2em;">
                            {{ item.value }}
                        </strong>
                        <div class="badge badge-secondary float-right">{{ item.status }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- 2. Core Analysis (Part I) -->
    <div class="row">
        <!-- MOAT (Ch 3) -->
        <div class="col-md-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header card-header-dorsey">
                    <h5 class="mb-0"><i class="fas fa-shield-alt text-primary"></i> Economic Moat</h5>
                </div>
                <div class="card-body">
                    <h3 class="text-center mb-3">{{ moat_analysis.moat_rating }}</h3>
                    <ul class="list-group list-group-flush bg-transparent">
                        {% for d in moat_analysis.details %}
                        <li class="list-group-item bg-transparent text-light border-secondary">
                            <div class="d-flex justify-content-between">
                                <span>{{ d.metric }}</span>
                                <span class="font-weight-bold">{{ d.value }}</span>
                            </div>
                            <small class="text-muted">{{ d.comment }}</small>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>

        <!-- VALUATION (Ch 9 & 10) -->
        <div class="col-md-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header card-header-dorsey">
                    <h5 class="mb-0"><i class="fas fa-tags text-success"></i> Valuation (DCF)</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3 text-center">
                        <small class="text-uppercase text-muted">{{ valuation.model_type }} Model</small>
                    </div>

                    <div class="row text-center mb-3">
                        <!-- Conservative -->
                        <div class="col-4 border-right border-secondary">
                            <small class="text-muted">Conservative</small>
                            <h4 class="text-warning">₹{{ "%.0f"|format(valuation.scenarios.Conservative.value) }}</h4>
                            <small style="font-size: 0.6em;">Gr: {{ "%.1f"|format(valuation.scenarios.Conservative.growth_used) }}%</small>
                        </div>
                        <!-- Base -->
                        <div class="col-4 border-right border-secondary">
                            <small class="text-info font-weight-bold">Base Case</small>
                            <h2 class="{% if valuation.intrinsic_value > 0 %}text-success{% else %}text-danger{% endif %} text-nowrap">
                                ₹{{ "%.0f"|format(valuation.intrinsic_value) }}
                            </h2>
                            {% if valuation.intrinsic_value < 0 %}
                                <small class="d-block text-danger">(Value Destruction)</small>
                            {% endif %}
                        </div>
                        <!-- Optimistic -->
                        <div class="col-4">
                            <small class="text-muted">Optimistic</small>
                            <h4 class="text-success">₹{{ "%.0f"|format(valuation.scenarios.Optimistic.value) }}</h4>
                            <small style="font-size: 0.6em;">Gr: {{ "%.1f"|format(valuation.scenarios.Optimistic.growth_used) }}%</small>
                        </div>
                    </div>

                    <div class="text-center">
                        <small>Current Price: ₹{{ valuation.current_price }}</small>
                        <br>
                        {% if valuation.margin_of_safety > 0 %}
                            <span class="badge badge-success mt-2">Margin of Safety: {{ "%.1f"|format(valuation.margin_of_safety) }}%</span>
                        {% else %}
                             <span class="badge badge-warning mt-2">Premium: {{ "%.1f"|format(valuation.margin_of_safety * -1) if valuation.margin_of_safety else "N/A" }}%</span>
                        {% endif %}
                    </div>
                    <hr class="border-secondary">
                    <div class="alert {% if 'BUY' in valuation.verdict %}alert-success{% elif 'SELL' in valuation.verdict %}alert-danger{% else %}alert-warning{% endif %} text-center mb-0">
                        <strong>{{ valuation.verdict }}</strong>
                    </div>
                    <p class="mt-2 text-center small text-muted">
                        Margin of Safety: {{ "%.1f"|format(valuation.margin_of_safety) }}%
                    </p>
                </div>
            </div>
        </div>

        <!-- FINANCIALS (Ch 5-8) -->
        <div class="col-md-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header card-header-dorsey">
                    <h5 class="mb-0"><i class="fas fa-heartbeat text-danger"></i> Financial Health</h5>
                </div>
                <div class="card-body">
                    <h4 class="text-center {{ 'text-success' if financial_health.health_rating == 'Robust' else 'text-warning' }}">{{ financial_health.health_rating }}</h4>
                    
                    {% if financial_health.red_flags %}
                    <div class="alert alert-danger mt-3">
                        <strong><i class="fas fa-exclamation-triangle"></i> Red Flags:</strong>
                        <ul class="mb-0 pl-3">
                            {% for flag in financial_health.red_flags %}
                            <li>{{ flag }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% else %}
                    <div class="alert alert-success mt-3">
                        <i class="fas fa-check-circle"></i> No accounting red flags detected.
                    </div>
                    {% endif %}
                    
                     <ul class="list-group list-group-flush bg-transparent mt-2">
                        {% for c in financial_health.checks %}
                        <li class="list-group-item bg-transparent text-light border-secondary d-flex justify-content-between">
                            <span>{{ c.metric }}</span>
                            <span>{{ c.value }} ({{ c.status }})</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. Sector Deep Dive (Part II) -->
    <h3 class="section-title">Sector Guide: {{ sector_analysis.sector }}</h3>
    <div class="card shadow-sm mb-5">
        <div class="card-body">
            <div class="row">
                {% for insight in sector_analysis.insights %}
                <div class="col-md-4 mb-3">
                     <div class="p-3 border border-secondary rounded h-100">
                        <h5 class="text-info">{{ insight.metric }}</h5>
                        <h2 class="mb-2">{{ insight.value }}</h2>
                        <span class="badge badge-light mb-2">{{ insight.judgment }}</span>
                        <p class="text-muted small mb-0">{{ insight.context }}</p>
                     </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- 4. The Dorsey Theory (Educational Footnote) -->
    <div class="accordion mb-5" id="dorseyTheory">
        <div class="card bg-dark border-secondary">
            <div class="card-header" id="headingOne">
                <h2 class="mb-0">
                    <button class="btn btn-link btn-block text-left text-light" type="button" data-toggle="collapse" data-target="#collapseOne">
                        <i class="fas fa-book"></i> Read the Theory: Why do these checks matter?
                    </button>
                </h2>
            </div>
            <div id="collapseOne" class="collapse" aria-labelledby="headingOne" data-parent="#dorseyTheory">
                <div class="card-body text-muted">
                    <h5>1. The 10-Minute Test (Chapter 12)</h5>
                    <p>Designed to filter out "No-Go" stocks immediately. 
                       <strong>Free Cash Flow</strong> is the lifeblood; without it, a company relies on debt. 
                       <strong>ROE > 15%</strong> shows management skill in compounding capital. 
                       <strong>Debt/Equity</strong> checks prevent bankruptcy risk during downturns.</p>
                    
                    <h5>2. The Moat (Chapter 3)</h5>
                    <p>A "Moat" is a structural advantage protecting profits. 
                       <strong>ROIC (Return on Invested Capital)</strong> is the gold standard. 
                       If ROIC > Cost of Capital (approx 10%) for 10+ years, the company has a moat. 
                       Wide Moats are rare and valuable.</p>
                       
                    <h5>3. Valuation (Chapters 9-10)</h5>
                    <p>We use a <strong>Discounted Cash Flow (DCF)</strong> model. 
                       It projects future cash flows, discounts them back to today using a 11% rate (conservative for India), and sums them up. 
                       <strong>Margin of Safety:</strong> We only buy if Price is 30% <em>below</em> Intrinsic Value to protect against errors.</p>
                       
                    <h5>4. Red Flags (Financial Fakery)</h5>
                    <p><strong>Inventory Bloat:</strong> If inventory grows faster than sales, products are piling up (unsold). 
                       <strong>Receivables Bloat:</strong> If receivables surge, the company might be "stuffing the channel" to fake sales.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Search Auto-Complete Script -->
<script>
    const input = document.getElementById("ticker-input");
    const suggestions = document.getElementById("suggestions-list");
    let timeout = null;

    input.addEventListener("input", (e) => {
        clearTimeout(timeout);
        const q = e.target.value.trim();
        if (!q || q.length < 2) {
            suggestions.innerHTML = "";
            return;
        }
        timeout = setTimeout(async () => {
            try {
                const res = await fetch(`/suggest?query=${encodeURIComponent(q)}`);
                const data = await res.json();
                suggestions.innerHTML = "";
                const raw = data.suggestions;

                if (raw) {
                    // Helper to create list item
                    const makeLi = (text, ticker) => {
                        const li = document.createElement("li");
                        li.className = "list-group-item list-group-item-action bg-dark text-light border-secondary";
                        li.style.cursor = "pointer";
                        li.textContent = text;
                        li.addEventListener("click", () => {
                            input.value = ticker;
                            suggestions.innerHTML = "";
                            // Auto-submit on selection for better UX
                             input.closest('form').submit(); 
                        });
                        return li;
                    };

                    if (Array.isArray(raw)) {
                        raw.forEach(s => suggestions.appendChild(makeLi(`${s.name} (${s.ticker})`, s.ticker)));
                    } else if (typeof raw === "object") {
                        Object.keys(raw).forEach(name => suggestions.appendChild(makeLi(`${name} (${raw[name]})`, raw[name])));
                    }
                }
            } catch (err) {
                console.warn("Suggestion fetch failed", err);
            }
        }, 300);
    });

    // Close suggestions on click outside
    document.addEventListener("click", (e) => {
        if (!input.contains(e.target) && !suggestions.contains(e.target)) {
            suggestions.innerHTML = "";
        }
    });
</script>

</body>
</html>
