<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Pattern Recognition Training - Stock Analysis</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/static/styles.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/premium.css') }}" />
    <!-- Plotly.js for interactive charts -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
      /* Dark theme pattern training */
      .pattern-page .container {
        padding-top: 20px;
      }
      
      .pattern-page h3 {
        color: #fff;
        margin-bottom: 1.5rem;
      }

      .header-section {
        background: linear-gradient(135deg, rgba(108, 126, 246, 0.3), rgba(0, 212, 255, 0.2));
        color: white;
        padding: 20px 0;
        border-radius: 12px;
        margin-bottom: 20px;
        border: 1px solid rgba(108, 126, 246, 0.3);
        backdrop-filter: blur(10px);
      }

      .pattern-card {
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid rgba(108, 126, 246, 0.25);
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        margin-bottom: 20px;
        cursor: pointer;
        min-height: 44px;
        backdrop-filter: blur(10px);
      }

      .pattern-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(108, 126, 246, 0.2);
        border-color: rgba(108, 126, 246, 0.5);
      }
      
      .pattern-card .card-body {
        color: #eaf3ff;
      }
      
      .pattern-card .card-title {
        color: var(--accent-blue, #38bdf8);
      }
      
      .pattern-card .card-text {
        color: rgba(255, 255, 255, 0.7);
      }

      /* Responsive breakpoints */
      @media (min-width: 768px) {
        .header-section {
          padding: 30px 0;
          margin-bottom: 30px;
        }
      }

      .exercise-container {
        display: none;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-top: 20px;
      }

      .pattern-zone {
        cursor: crosshair;
        opacity: 0.7;
      }

      .pattern-zone:hover {
        opacity: 1;
      }

      .feedback-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        display: none;
      }

      .progress-indicator {
        height: 6px;
        background: #e9ecef;
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 10px;
      }

      .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #007bff, #28a745);
        transition: width 0.3s ease;
      }

      .learning-stage-badge {
        font-size: 0.875rem;
        padding: 4px 12px;
        border-radius: 20px;
        font-weight: 500;
      }

      .stage-guided {
        background: #e3f2fd;
        color: #1565c0;
      }
      .stage-assisted {
        background: #e8f5e8;
        color: #2e7d32;
      }
      .stage-independent {
        background: #fff3e0;
        color: #f57c00;
      }
      .stage-mastery {
        background: #fce4ec;
        color: #c2185b;
      }

      /* Chart Container Styling */
      #chart-container {
        min-height: 550px;
        height: 550px;
        width: 100%;
        margin-top: 20px;
        margin-bottom: 30px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        background: white;
      }

      .exercise-container {
        margin-top: 30px;
      }

      .exercise-container .card-header {
        padding: 20px;
      }

      .exercise-container .card-body {
        padding: 20px;
      }
      
      /* Toast notifications for chart markers */
      .marker-toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: rgba(40, 167, 69, 0.95);
        color: white;
        padding: 10px 20px;
        border-radius: 25px;
        font-weight: 500;
        z-index: 9999;
        opacity: 0;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      }
      .marker-toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
      
      /* Marker count badge */
      #marker-count {
        background: linear-gradient(135deg, #ff6b6b, #dc3545);
        color: white;
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 0.85rem;
        font-weight: 500;
        display: none;
      }
      
      /* Clear markers button */
      #clear-markers-btn {
        display: none;
        font-size: 0.8rem;
      }
      
      /* Master Tips Panel */
      .master-tips-panel {
        background: linear-gradient(135deg, rgba(108, 126, 246, 0.1), rgba(0, 212, 255, 0.1));
        border: 1px solid rgba(108, 126, 246, 0.3);
        border-radius: 8px;
        padding: 12px;
        margin-top: 15px;
      }
      .master-tips-panel h6 {
        color: #6c7ee6;
        margin-bottom: 8px;
        font-size: 0.9rem;
      }
      .master-tips-content {
        font-size: 0.85rem;
        color: #555;
        line-height: 1.5;
      }
      .master-tips-content.highlight {
        background: rgba(255, 193, 7, 0.15);
        border-left: 3px solid #ffc107;
        padding: 8px 12px;
        border-radius: 0 6px 6px 0;
      }
      
      /* Gamification: Streak Counter */
      .streak-counter {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: linear-gradient(135deg, #ff9800, #ff5722);
        color: white;
        padding: 6px 14px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
        box-shadow: 0 3px 10px rgba(255, 87, 34, 0.3);
        animation: pulse-glow 2s infinite;
      }
      .streak-counter.frozen {
        background: linear-gradient(135deg, #78909c, #546e7a);
        animation: none;
      }
      .streak-counter .streak-fire {
        font-size: 1.1rem;
      }
      @keyframes pulse-glow {
        0%, 100% { box-shadow: 0 3px 10px rgba(255, 87, 34, 0.3); }
        50% { box-shadow: 0 3px 20px rgba(255, 87, 34, 0.5); }
      }
      
      /* Gamification: Session Progress */
      .session-progress-container {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 8px 15px;
        display: inline-flex;
        align-items: center;
        gap: 10px;
      }
      .session-progress-bar {
        width: 120px;
        height: 8px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        overflow: hidden;
      }
      .session-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #00d4ff, #6c7ee6);
        border-radius: 4px;
        transition: width 0.5s ease;
      }
      .session-progress-text {
        color: white;
        font-size: 0.85rem;
        font-weight: 500;
      }
      
      /* Gamification: Achievement Badge */
      .achievement-popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0);
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 30px 40px;
        border-radius: 16px;
        text-align: center;
        z-index: 10000;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        opacity: 0;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
      .achievement-popup.show {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
      .achievement-popup .trophy {
        font-size: 3rem;
        margin-bottom: 10px;
      }
      .achievement-popup h4 {
        margin: 0 0 5px 0;
        font-size: 1.3rem;
      }
      .achievement-popup p {
        margin: 0;
        opacity: 0.9;
        font-size: 0.95rem;
      }
      
      /* Confetti animation for achievements */
      .confetti {
        position: fixed;
        top: -10px;
        z-index: 9999;
        pointer-events: none;
      }
      @keyframes confetti-fall {
        0% {
          transform: translateY(0) rotate(0deg);
          opacity: 1;
        }
        100% {
          transform: translateY(100vh) rotate(720deg);
          opacity: 0;
        }
      }
      
      /* Chart marking instruction */
      .chart-marking-hint {
        background: rgba(0, 123, 255, 0.1);
        border: 1px dashed rgba(0, 123, 255, 0.4);
        border-radius: 6px;
        padding: 8px 12px;
        font-size: 0.8rem;
        color: #0056b3;
        margin-bottom: 10px;
      }
    </style>
  </head>
  <body class="pattern-page">
    {% include '_header.html' %}

    <div class="container" style="padding-top: 20px">
      <!-- Header Section -->
      <div class="header-section text-center">
        <h1 class="mb-3">üéØ Pattern Recognition Training</h1>
        <p class="lead mb-0">
          Master financial pattern recognition through interactive exercises
        </p>
        <div class="mt-3 d-flex justify-content-center align-items-center flex-wrap gap-3">
          <span
            class="learning-stage-badge stage-{{ user_stage.replace('_', '-') }}"
          >
            Learning Stage: {{ user_stage.replace('_', ' ').title() }}
          </span>
          
          <!-- Streak Counter -->
          <span class="streak-counter" id="streak-counter" title="Your current streak of correct answers (‚â•50% accuracy)">
            <span class="streak-fire">üî•</span>
            <span id="streak-value">0</span> streak
          </span>
          
          <!-- Session Progress -->
          <div class="session-progress-container" id="session-progress">
            <span class="session-progress-text">Session: <span id="exercises-completed">0</span>/5</span>
            <div class="session-progress-bar">
              <div class="session-progress-fill" id="session-progress-fill" style="width: 0%"></div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Achievement Popup (hidden by default) -->
      <div class="achievement-popup" id="achievement-popup">
        <div class="trophy">üèÜ</div>
        <h4 id="achievement-title">Achievement Unlocked!</h4>
        <p id="achievement-text">Great job!</p>
      </div>

      <!-- Pattern Selection -->
      <div class="row" id="pattern-selection">
        <div class="col-12">
          <h3 class="text-center mb-4">Choose Your Training Focus</h3>
        </div>
        {% for pattern in available_patterns %}
        <div class="col-lg-4 col-md-6 col-sm-12 mb-3">
          <div
            class="card pattern-card h-100"
            onclick="selectPattern('{{ pattern.type }}')"
          >
            <div class="card-body text-center">
              <h5 class="card-title text-primary">{{ pattern.name }}</h5>
              <p class="card-text">{{ pattern.description }}</p>
              <div class="mt-auto">
                <button class="btn btn-outline-primary">
                  Select Pattern ‚Üí
                </button>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Stock Selection Panel -->
      <div class="row" id="stock-selection" style="display: none">
        <div class="col-12">
          <div class="card">
            <div
              class="card-header bg-info text-white d-flex justify-content-between align-items-center"
            >
              <h4 class="mb-0">üìà Choose Your Stock</h4>
              <button
                class="btn btn-sm btn-outline-light"
                onclick="backToPatterns()"
              >
                ‚Üê Back to Patterns
              </button>
            </div>
            <div class="card-body">
              <p class="lead mb-4">
                Select a stock to analyze or choose random selection:
              </p>

              <div class="row mb-3">
                <div class="col-md-6 col-sm-12 mb-2">
                  <button
                    class="btn btn-success btn-lg btn-block"
                    onclick="startExercise(selectedPatternType, null)"
                  >
                    üé≤ Random Stock
                  </button>
                  <small class="text-muted"
                    >Let the system choose a suitable company</small
                  >
                </div>
                <div class="col-md-6 col-sm-12">
                  <div class="form-group">
                    <label for="stock-dropdown" class="font-weight-bold"
                      >Or select specific stock:</label
                    >
                    <select
                      id="stock-dropdown"
                      class="form-control form-control-lg"
                    >
                      <option value="">Loading stocks...</option>
                    </select>
                  </div>
                  <button
                    class="btn btn-primary btn-lg btn-block"
                    onclick="startWithSelectedStock()"
                    id="start-selected-btn"
                    disabled
                  >
                    üéØ Start with Selected Stock
                  </button>
                </div>
              </div>

              <div class="text-center">
                <small class="text-muted">
                  <i class="fas fa-info-circle"></i>
                  Note: All exercises use synthetic educational data designed
                  for pattern recognition training.<br />
                  <i class="fas fa-mouse-pointer"></i>
                  Hover over highlighted areas and markers for pattern hints!
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Exercise Container -->
      <div id="exercise-container" class="exercise-container">
        <div
          class="card-header bg-primary text-white d-flex justify-content-between align-items-center"
        >
          <h4 class="mb-0" id="exercise-title">Pattern Recognition Exercise</h4>
          <div>
            <button
              class="btn btn-sm btn-outline-light ml-2"
              onclick="returnToSelection()"
            >
              ‚Üê Back to Selection
            </button>
          </div>
        </div>
        <div class="card-body">
          <!-- Exercise Description -->
          <div class="row mb-4">
            <div class="col-12">
              <p class="lead" id="exercise-description">Loading exercise...</p>
            </div>
          </div>

          <div class="row">
            <div class="col-md-9">
              <!-- Chart Container -->
              <div id="chart-container">
                <div class="text-center mt-5">
                  <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Loading chart...</span>
                  </div>
                  <p class="mt-2">Loading interactive chart...</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <!-- Instructions Panel -->
              <div class="card bg-light">
                <div class="card-header">
                  <h6 class="mb-0">üìã Instructions</h6>
                </div>
                <div class="card-body">
                  <p id="instructions-text" class="small">
                    Analyze the chart and identify the patterns present.
                  </p>

                  <!-- Pattern Selection Buttons -->
                  <div id="pattern-buttons" class="mt-3">
                    <h6 class="small text-muted">
                      Click patterns you identify:
                    </h6>
                    <div
                      class="btn-group-vertical btn-group-sm w-100"
                      id="pattern-button-group"
                    >
                      <!-- Dynamic pattern buttons will be inserted here -->
                    </div>
                  </div>
                  
                  <!-- Chart Marking Feature -->
                  <div class="chart-marking-hint mt-3">
                    üí° <strong>Tip:</strong> Click directly on the chart to mark key points you've identified.
                  </div>
                  <div class="d-flex align-items-center justify-content-between mt-2">
                    <span id="marker-count" class="badge">0 points</span>
                    <button id="clear-markers-btn" class="btn btn-outline-danger btn-sm" onclick="clearChartMarkers()">
                      Clear Markings
                    </button>
                  </div>

                  <!-- Submit Section -->
                  <div class="mt-4">
                    <button
                      class="btn btn-success btn-block"
                      id="submit-btn"
                      onclick="submitAttempt()"
                    >
                      Submit Analysis
                    </button>
                  </div>
                  
                  <!-- Master Tips Panel -->
                  <div class="master-tips-panel mt-3">
                    <h6>üí° Master Tips</h6>
                    <div id="master-tips-content" class="master-tips-content">
                      Hover over the chart to see context-specific insights about the financial metrics.
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Feedback Section -->
          <div id="feedback-section" class="feedback-section">
            <h5>üìä Results & Feedback</h5>
            <div class="row">
              <div class="col-md-6">
                <div class="progress-indicator">
                  <div
                    class="progress-bar"
                    id="score-progress"
                    style="width: 0%"
                  ></div>
                </div>
                <p class="small text-muted mb-2">Accuracy Score</p>
                <h4 class="text-primary" id="accuracy-score">--</h4>
              </div>
              <div class="col-md-6">
                <p class="small text-muted mb-2">Time Taken</p>
                <h5 id="time-taken">--</h5>
              </div>
            </div>
            <div class="mt-3">
              <h6>Feedback:</h6>
              <div id="feedback-content">
                <!-- Feedback will be inserted here -->
              </div>
            </div>
            <div class="mt-3 text-center">
              <button class="btn btn-primary mr-2" onclick="startNewExercise()">
                Try Another Exercise
              </button>
              <button
                class="btn btn-outline-secondary"
                onclick="returnToSelection()"
              >
                Change Pattern Type
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- JavaScript -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
      let currentExercise = null;
      let startTime = null;
      let selectedPatterns = new Set();
      let selectedPatternType = null;
      let availableStocks = [];
      
      // Gamification state
      let sessionExercisesCompleted = 0;
      const SESSION_TARGET = 5;
      
      // Streak tracking with localStorage
      function getStreak() {
        const data = localStorage.getItem('patternTrainingStreak');
        if (!data) return { count: 0, lastDate: null };
        try {
          return JSON.parse(data);
        } catch {
          return { count: 0, lastDate: null };
        }
      }
      
      function setStreak(count) {
        const today = new Date().toDateString();
        localStorage.setItem('patternTrainingStreak', JSON.stringify({
          count: count,
          lastDate: today
        }));
        updateStreakDisplay(count);
      }
      
      function updateStreakDisplay(count) {
        $('#streak-value').text(count);
        const counter = $('#streak-counter');
        if (count > 0) {
          counter.removeClass('frozen');
        } else {
          counter.addClass('frozen');
        }
        
        // Animate on update
        counter.css('transform', 'scale(1.2)');
        setTimeout(() => counter.css('transform', 'scale(1)'), 200);
      }
      
      function checkStreakContinuity() {
        const streak = getStreak();
        const today = new Date().toDateString();
        const lastDate = streak.lastDate;
        
        if (!lastDate) {
          return 0;
        }
        
        const lastDateObj = new Date(lastDate);
        const todayObj = new Date(today);
        const diffDays = Math.floor((todayObj - lastDateObj) / (1000 * 60 * 60 * 24));
        
        // If more than 1 day has passed, reset streak
        if (diffDays > 1) {
          return 0;
        }
        
        return streak.count;
      }
      
      function handleExerciseResult(accuracy) {
        sessionExercisesCompleted++;
        updateSessionProgress();
        
        // Streak logic: 50%+ accuracy maintains/increases streak
        let currentStreak = checkStreakContinuity();
        
        if (accuracy >= 0.5) {
          currentStreak++;
          setStreak(currentStreak);
          
          // Check for achievements
          checkAchievements(accuracy, currentStreak);
        } else {
          // Failed - reset streak
          setStreak(0);
        }
      }
      
      function updateSessionProgress() {
        const percent = Math.min((sessionExercisesCompleted / SESSION_TARGET) * 100, 100);
        $('#exercises-completed').text(sessionExercisesCompleted);
        $('#session-progress-fill').css('width', percent + '%');
        
        // Session completed achievement
        if (sessionExercisesCompleted === SESSION_TARGET) {
          showAchievement('üéØ', 'Session Complete!', 'You completed 5 exercises this session!');
        }
      }
      
      function checkAchievements(accuracy, streak) {
        // Perfect score
        if (accuracy === 1.0) {
          showAchievement('‚≠ê', 'Perfect Score!', 'You identified all patterns correctly!');
        }
        // Streak milestones
        else if (streak === 3) {
          showAchievement('üî•', 'On Fire!', '3 correct answers in a row!');
        }
        else if (streak === 5) {
          showAchievement('üåü', 'Streak Master!', '5 correct answers in a row!');
        }
        else if (streak === 10) {
          showAchievement('üëë', 'Pattern Pro!', '10 correct answers in a row!');
        }
      }
      
      function showAchievement(emoji, title, text) {
        const popup = $('#achievement-popup');
        popup.find('.trophy').text(emoji);
        $('#achievement-title').text(title);
        $('#achievement-text').text(text);
        
        popup.addClass('show');
        
        // Create confetti effect
        createConfetti();
        
        // Hide after 3 seconds
        setTimeout(() => {
          popup.removeClass('show');
        }, 3000);
      }
      
      function createConfetti() {
        const colors = ['#ff6b6b', '#4ecdc4', '#ffe66d', '#6c7ee6', '#ff9800'];
        for (let i = 0; i < 50; i++) {
          const confetti = $('<div class="confetti"></div>');
          confetti.css({
            left: Math.random() * 100 + 'vw',
            background: colors[Math.floor(Math.random() * colors.length)],
            width: Math.random() * 10 + 5 + 'px',
            height: Math.random() * 10 + 5 + 'px',
            borderRadius: Math.random() > 0.5 ? '50%' : '0',
            animation: `confetti-fall ${Math.random() * 2 + 2}s ease-out forwards`
          });
          $('body').append(confetti);
          setTimeout(() => confetti.remove(), 4000);
        }
      }

      // Load available stocks when page loads
      $(document).ready(function () {
        loadAvailableStocks();
        
        // Initialize streak display
        const streak = checkStreakContinuity();
        updateStreakDisplay(streak);
      });

      function loadAvailableStocks() {
        $.get("/pattern-training/stocks")
          .done(function (response) {
            if (response.success) {
              availableStocks = response.stocks;
              populateStockDropdown();
            } else {
              console.error("Failed to load stocks");
            }
          })
          .fail(function () {
            console.error("Network error loading stocks");
          });
      }

      function populateStockDropdown() {
        const dropdown = $("#stock-dropdown");
        dropdown.empty();
        dropdown.append('<option value="">Select a stock...</option>');

        availableStocks.forEach((stock) => {
          const value = `${stock.name}|${stock.ticker}|${stock.industry}`;
          const displayText = `${stock.name} (${stock.ticker}) - ${
            stock.index || "Unknown Index"
          }`;
          dropdown.append(`<option value="${value}">${displayText}</option>`);
        });

        // Enable the start button when a stock is selected
        dropdown.on("change", function () {
          $("#start-selected-btn").prop("disabled", !$(this).val());
        });
      }

      function selectPattern(patternType) {
        selectedPatternType = patternType;
        $("#pattern-selection").hide();
        $("#stock-selection").show();
      }

      function backToPatterns() {
        $("#stock-selection").hide();
        $("#pattern-selection").show();
        selectedPatternType = null;
      }

      function startWithSelectedStock() {
        const selectedStock = $("#stock-dropdown").val();
        if (!selectedStock) {
          alert("Please select a stock first");
          return;
        }
        startExercise(selectedPatternType, selectedStock);
      }

      function startExercise(patternType, selectedStock = null) {
        $("#pattern-selection").hide();
        $("#stock-selection").hide();
        $("#exercise-container").show();

        // Clear previous state
        selectedPatterns.clear();
        $("#feedback-section").hide();

        // Build request parameters
        let requestParams = {
          pattern_type: patternType,
          stage: "{{ user_stage }}",
        };

        if (selectedStock) {
          requestParams.stock = selectedStock;
        }

        // Load exercise
        $.get("/pattern-training/exercise", requestParams)
          .done(function (response) {
            if (response.success) {
              currentExercise = response.exercise;
              displayExercise(response.exercise);
            } else {
              alert("Failed to load exercise: " + response.error);
            }
          })
          .fail(function () {
            alert("Network error while loading exercise");
          });
      }

      function displayExercise(exercise) {
        // Set title and description
        $("#exercise-title").text(exercise.title);
        $("#exercise-description").text(exercise.description);
        
        // Update instructions panel with educational context
        if (exercise.educational_context) {
          $("#instructions-text").html(exercise.educational_context);
        } else {
          $("#instructions-text").text(exercise.description);
        }

        // Parse and render chart with Plotly
        console.log("Received chart data:", exercise.chart_html);

        try {
          const chartData = JSON.parse(exercise.chart_html);
          console.log("Parsed chart data:", chartData);

          // Clear the container first
          $("#chart-container").empty();

          // Configure chart layout with proper sizing
          const layout = {
            ...chartData.layout,
            height: 480,
            margin: { t: 60, b: 80, l: 80, r: 80 },
            showlegend: true,
            legend: {
              orientation: "h",
              y: -0.15,
              x: 0.5,
              xanchor: "center",
            },
            title: {
              ...chartData.layout?.title,
              y: 0.98, // Position title closer to top but within chart bounds
              yanchor: "top",
              font: {
                size: 16,
              },
            },
          };

          const config = {
            responsive: true,
            displayModeBar: true,
            displaylogo: false,
            modeBarButtonsToRemove: ["pan2d", "lasso2d", "select2d"],
            modeBarButtonsToAdd: [],
            toImageButtonOptions: {
              format: "png",
              filename: "pattern_chart",
              height: 500,
              width: 800,
              scale: 1,
            },
          };

          // Create the Plotly chart
          Plotly.newPlot("chart-container", chartData.data, layout, config);
          console.log("Chart rendered successfully");
          
          // Setup click-on-chart pattern marking
          const chartDiv = document.getElementById("chart-container");
          chartDiv.on("plotly_click", function(data) {
            if (data.points.length > 0) {
              const point = data.points[0];
              addChartMarker(point.x, point.y, point.curveNumber);
            }
          });
          
          // Setup hover tooltips for Master Tips
          chartDiv.on("plotly_hover", function(data) {
            if (data.points.length > 0) {
              const point = data.points[0];
              updateMasterTips(point.x, point.y, point.data.name);
            }
          });
          
        } catch (e) {
          console.error("Failed to parse chart data:", e);
          $("#chart-container").html(
            '<div class="alert alert-danger">Error loading chart. Please try again.</div>'
          );
        }

        // Create pattern buttons based on pattern type
        createPatternButtons(exercise.pattern_type);
        
        // Clear any previous chart markers
        chartMarkers = [];
        updateMarkerCount();

        // Record start time for analytics (no countdown)
        startTime = Date.now();
      }
      
      // Chart marker storage
      let chartMarkers = [];
      
      function addChartMarker(x, y, curveNumber) {
        // Add a marker to track clicked points
        const marker = { x, y, curveNumber, id: Date.now() };
        chartMarkers.push(marker);
        
        // Add visual marker to chart
        const chartDiv = document.getElementById("chart-container");
        const currentData = chartDiv.data;
        
        // Create a new marker trace
        const markerTrace = {
          x: chartMarkers.map(m => m.x),
          y: chartMarkers.map(m => m.y),
          mode: "markers",
          type: "scatter",
          name: "Your Markings",
          marker: {
            size: 18,
            symbol: "circle",
            color: "rgba(255, 107, 107, 0.8)",
            line: { color: "#dc3545", width: 3 }
          },
          hovertemplate: "üìç Marked Point<br>%{x}<br>Value: %{y}<extra></extra>",
          showlegend: true
        };
        
        // Check if marker trace already exists
        const markerTraceIndex = currentData.findIndex(t => t.name === "Your Markings");
        if (markerTraceIndex >= 0) {
          // Update existing trace
          Plotly.restyle(chartDiv, {
            x: [chartMarkers.map(m => m.x)],
            y: [chartMarkers.map(m => m.y)]
          }, [markerTraceIndex]);
        } else {
          // Add new trace
          Plotly.addTraces(chartDiv, markerTrace);
        }
        
        updateMarkerCount();
        
        // Show feedback toast
        showMarkerToast(`Point marked at ${x}`);
      }
      
      function clearChartMarkers() {
        chartMarkers = [];
        const chartDiv = document.getElementById("chart-container");
        if (!chartDiv || !chartDiv.data) return;
        
        // Remove marker trace
        const markerTraceIndex = chartDiv.data.findIndex(t => t.name === "Your Markings");
        if (markerTraceIndex >= 0) {
          Plotly.deleteTraces(chartDiv, markerTraceIndex);
        }
        
        updateMarkerCount();
      }
      
      function updateMarkerCount() {
        const count = chartMarkers.length;
        const badge = $("#marker-count");
        if (count > 0) {
          badge.text(`${count} point${count > 1 ? 's' : ''} marked`).show();
          $("#clear-markers-btn").show();
        } else {
          badge.hide();
          $("#clear-markers-btn").hide();
        }
      }
      
      function showMarkerToast(message) {
        // Simple toast notification
        const toast = $(`<div class="marker-toast">${message}</div>`);
        $("body").append(toast);
        setTimeout(() => toast.addClass("show"), 10);
        setTimeout(() => {
          toast.removeClass("show");
          setTimeout(() => toast.remove(), 300);
        }, 1500);
      }
      
      // Master Tips - context-specific educational content
      const masterTipsLibrary = {
        debt_analysis: {
          "Debt-to-Equity": {
            high: "‚ö†Ô∏è <strong>High D/E Warning:</strong> A D/E ratio above 1.5 often indicates aggressive leveraging. Check if the industry norm justifies this level.",
            low: "‚úÖ <strong>Conservative Leverage:</strong> Low D/E suggests financial prudence. However, ensure the company isn't missing growth opportunities.",
            trend_up: "üìà <strong>Rising Debt:</strong> Increasing D/E could signal expansion or distress. Look at revenue growth to differentiate.",
            trend_down: "üìâ <strong>Deleveraging:</strong> Decreasing D/E is positive - indicates debt repayment or equity growth."
          },
          "Interest Coverage": {
            high: "‚úÖ <strong>Strong Coverage:</strong> High interest coverage (>5x) means comfortable debt servicing ability.",
            low: "‚ö†Ô∏è <strong>Coverage Concern:</strong> Interest coverage below 2x is a red flag - the company may struggle to meet interest payments.",
            default: "üí° <strong>Interest Coverage:</strong> This ratio shows how many times EBIT covers interest expenses. Higher is better."
          },
          "Current Ratio": {
            default: "üí° <strong>Liquidity Check:</strong> Current ratio >1.5 indicates healthy short-term liquidity. Watch for seasonal patterns."
          }
        },
        growth_indicators: {
          "Return on Equity (%)": {
            high: "üåü <strong>Excellent ROE:</strong> ROE above 18% indicates efficient use of shareholder capital. Verify it's sustainable.",
            low: "‚ö†Ô∏è <strong>Low ROE:</strong> ROE below 10% suggests poor capital efficiency. Compare with sector peers.",
            default: "üí° <strong>ROE Insight:</strong> Strong, consistent ROE (15%+) is a hallmark of quality businesses."
          },
          "Revenue Growth (%)": {
            high: "üìà <strong>Strong Growth:</strong> Double-digit revenue growth is excellent. Confirm it's organic, not acquisition-driven.",
            low: "üìâ <strong>Stagnation:</strong> Low/negative growth may indicate market saturation or competitive pressures.",
            default: "üí° <strong>Growth Tip:</strong> Look for sustainable 10-15% revenue growth in quality companies."
          },
          "Operating Margin (%)": {
            default: "üí° <strong>Margin Focus:</strong> Expanding operating margins suggest pricing power and cost control."
          }
        },
        value_traps: {
          "P/E Ratio": {
            low: "‚ö†Ô∏è <strong>Value Trap Alert:</strong> Low P/E alone isn't enough. Check if earnings quality is declining!",
            high: "üí∞ <strong>Growth Premium:</strong> High P/E may be justified if growth prospects are strong.",
            default: "üí° <strong>Valuation Check:</strong> Compare P/E with historical average and sector peers."
          },
          "P/B Ratio": {
            low: "‚ö†Ô∏è <strong>Scrutinize Assets:</strong> Low P/B may hide hidden liabilities or impaired assets.",
            default: "üí° <strong>Book Value:</strong> P/B below 1 warrants investigation - could be value or value trap."
          },
          "ROE (%)": {
            trend_down: "üö® <strong>Deteriorating Quality:</strong> Declining ROE alongside low valuation = classic value trap signal!",
            default: "üí° <strong>Quality Check:</strong> Ensure ROE is stable or improving before buying low-valuation stocks."
          }
        }
      };
      
      let lastTipUpdate = 0;
      
      function updateMasterTips(x, y, metricName) {
        // Throttle updates to avoid excessive re-renders
        const now = Date.now();
        if (now - lastTipUpdate < 300) return;
        lastTipUpdate = now;
        
        if (!currentExercise || !selectedPatternType) return;
        
        const patternType = selectedPatternType;
        const tipsForPattern = masterTipsLibrary[patternType];
        if (!tipsForPattern) return;
        
        // Find applicable tip based on metric name
        let tip = null;
        
        // Try to match the metric
        for (const [metric, tips] of Object.entries(tipsForPattern)) {
          if (metricName && metricName.includes(metric.replace(' (%)', ''))) {
            // Determine which tip variant to show
            if (typeof y === 'number') {
              if (metric.includes('ROE') || metric.includes('Coverage')) {
                tip = y > 18 ? tips.high : y < 10 ? tips.low : tips.default;
              } else if (metric.includes('Debt-to-Equity')) {
                tip = y > 1.5 ? tips.high : y < 0.5 ? tips.low : tips.default;
              } else if (metric.includes('P/E') || metric.includes('P/B')) {
                tip = y < 10 ? tips.low : y > 25 ? tips.high : tips.default;
              } else {
                tip = tips.default || tips.high || tips.low;
              }
            } else {
              tip = tips.default || Object.values(tips)[0];
            }
            break;
          }
        }
        
        // Show the tip if found
        if (tip) {
          $("#master-tips-content")
            .html(tip)
            .addClass("highlight");
        }
      }
      
      // Reset Master Tips when mouse leaves chart
      $(document).ready(function() {
        $("#chart-container").on("mouseleave", function() {
          $("#master-tips-content")
            .html("Hover over the chart to see context-specific insights about the financial metrics.")
            .removeClass("highlight");
        });
      });

      function createPatternButtons(patternType) {
        const buttonGroup = $("#pattern-button-group");
        buttonGroup.empty();

        let patterns = [];

        if (patternType === "debt_analysis") {
          patterns = [
            { id: "deleveraging_trend", label: "Deleveraging Trend" },
            { id: "increasing_debt_trend", label: "Increasing Debt" },
            { id: "high_debt_periods", label: "High Debt Periods" },
            { id: "interest_coverage_concern", label: "Coverage Issues" },
          ];
        } else if (patternType === "growth_indicators") {
          patterns = [
            { id: "consistent_strong_roe", label: "Strong ROE" },
            { id: "roe_improvement_trend", label: "ROE Improvement" },
            { id: "healthy_revenue_growth", label: "Revenue Growth" },
          ];
        } else if (patternType === "value_traps") {
          patterns = [
            { id: "low_valuation", label: "Low Valuation" },
            {
              id: "deteriorating_fundamentals",
              label: "Deteriorating Fundamentals",
            },
            { id: "potential_value_trap", label: "Potential Value Trap" },
          ];
        }

        patterns.forEach((pattern) => {
          const btn = $(
            `<button type="button" class="btn btn-outline-primary btn-block mb-1" data-pattern="${pattern.id}" onclick="togglePattern('${pattern.id}')">${pattern.label}</button>`
          );
          buttonGroup.append(btn);
        });
      }

      function togglePattern(patternId) {
        const btn = $(`button[data-pattern="${patternId}"]`);

        if (selectedPatterns.has(patternId)) {
          selectedPatterns.delete(patternId);
          btn.removeClass("btn-primary").addClass("btn-outline-primary");
        } else {
          selectedPatterns.add(patternId);
          btn.removeClass("btn-outline-primary").addClass("btn-primary");
        }
      }

      function submitAttempt() {

        const timeTaken = Math.round((Date.now() - startTime) / 1000);

        $.ajax({
          url: "/pattern-training/submit",
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify({
            exercise_id: currentExercise.id,
            identified_patterns: Array.from(selectedPatterns),
            time_taken_seconds: timeTaken,
            chart_markers: chartMarkers.map(m => ({ x: m.x, y: m.y }))
          }),
        })
          .done(function (response) {
            if (response.success) {
              displayFeedback(response.result, timeTaken);
            } else {
              alert("Failed to submit: " + response.error);
            }
          })
          .fail(function () {
            alert("Network error while submitting");
          });
      }

      function displayFeedback(result, timeTaken) {
        // Show accuracy
        const accuracy = Math.round(result.accuracy * 100);
        $("#accuracy-score").text(accuracy + "%");
        $("#score-progress").css("width", accuracy + "%");
        
        // Update gamification (streak, session progress, achievements)
        handleExerciseResult(result.accuracy);

        // Show time taken
        const minutes = Math.floor(timeTaken / 60);
        const seconds = timeTaken % 60;
        $("#time-taken").text(`${minutes}m ${seconds}s`);

        // Show feedback
        let feedbackHtml = `<div class="alert alert-info">${result.feedback}</div>`;

        if (result.missed_patterns && result.missed_patterns.length > 0) {
          feedbackHtml +=
            '<div class="alert alert-warning"><strong>Missed Patterns:</strong><ul>';
          result.missed_patterns.forEach((pattern) => {
            feedbackHtml += `<li>${pattern}</li>`;
          });
          feedbackHtml += "</ul></div>";
        }

        if (result.recommendations && result.recommendations.length > 0) {
          feedbackHtml +=
            '<div class="alert alert-success"><strong>Recommendations:</strong><ul>';
          result.recommendations.forEach((rec) => {
            feedbackHtml += `<li>${rec}</li>`;
          });
          feedbackHtml += "</ul></div>";
        }
        
        // Add "Walk Me Through It" button for low accuracy (< 50%)
        if (accuracy < 50) {
          feedbackHtml += `
            <div class="mt-3 text-center">
              <button class="btn btn-warning btn-lg" onclick="showCorrectPatterns()">
                üéì Walk Me Through It
              </button>
              <p class="small text-muted mt-2">See where the patterns were hiding</p>
            </div>
          `;
        }

        $("#feedback-content").html(feedbackHtml);
        $("#feedback-section").show();
        
        // Auto-scroll to feedback section for immediate visibility
        $("#feedback-section")[0].scrollIntoView({ behavior: "smooth", block: "start" });
      }
      
      function showCorrectPatterns() {
        // Highlight all expected patterns on the chart
        if (!currentExercise || !currentExercise.expected_patterns) {
          alert("Pattern data not available");
          return;
        }
        
        // Scroll back to chart
        $("#chart-container")[0].scrollIntoView({ behavior: "smooth", block: "center" });
        
        // Helper to convert snake_case to Title Case
        function formatPatternName(pattern) {
          return pattern.replace(/_/g, ' ')
                        .replace(/\b\w/g, l => l.toUpperCase());
        }
        
        // Show educational message
        let walkthruHtml = `
          <div class="alert alert-info mb-3" id="learning-mode-box">
            <h5>üéì Learning Mode</h5>
            <p>The correct patterns for this exercise were:</p>
            <ul>
        `;
        
        currentExercise.expected_patterns.forEach((pattern) => {
          // Highlight the pattern button using data-pattern attribute
          const btn = $(`button[data-pattern="${pattern}"]`);
          if (btn.length) {
            btn.removeClass("btn-outline-primary btn-primary")
               .addClass("btn-success");
            // Only add checkmark if not already there
            if (!btn.text().includes('‚úì')) {
              btn.append(' ‚úì');
            }
          }
          walkthruHtml += `<li><strong>${formatPatternName(pattern)}</strong></li>`;
        });
        
        walkthruHtml += `
            </ul>
            <p class="mb-0"><em>Look for the highlighted zones on the chart - these indicate where the patterns appear.</em></p>
          </div>
        `;
        
        // Remove existing learning mode box if present
        $("#learning-mode-box").remove();
        
        // Prepend learning content to feedback
        $("#feedback-content").prepend(walkthruHtml);
        
        // Disable the Walk Me Through It button after use
        $("button:contains('Walk Me Through It')").prop("disabled", true).text("‚úì Patterns Revealed");
      }

      function startNewExercise() {
        // Reset the current exercise with same pattern type
        if (currentExercise && selectedPatternType) {
          // Go back to stock selection for the same pattern
          $("#exercise-container").hide();
          $("#stock-selection").show();
        }
      }

      function returnToSelection() {

        $("#exercise-container").hide();
        $("#stock-selection").hide();
        $("#pattern-selection").show();
        currentExercise = null;
        selectedPatterns.clear();
        selectedPatternType = null;
      }
    </script>
    {% include '_footer.html' %}
  </body>
</html>
