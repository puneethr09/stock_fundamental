<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Pattern Recognition Training - Stock Analysis</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/static/styles.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/premium.css') }}" />
    <!-- Plotly.js for interactive charts -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
      /* Dark theme pattern training */
      .pattern-page .container {
        padding-top: 20px;
      }
      
      .pattern-page h3 {
        color: #fff;
        margin-bottom: 1.5rem;
      }

      .header-section {
        background: linear-gradient(135deg, rgba(108, 126, 246, 0.3), rgba(0, 212, 255, 0.2));
        color: white;
        padding: 20px 0;
        border-radius: 12px;
        margin-bottom: 20px;
        border: 1px solid rgba(108, 126, 246, 0.3);
        backdrop-filter: blur(10px);
      }

      .pattern-card {
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid rgba(108, 126, 246, 0.25);
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        margin-bottom: 20px;
        cursor: pointer;
        min-height: 44px;
        backdrop-filter: blur(10px);
      }

      .pattern-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(108, 126, 246, 0.2);
        border-color: rgba(108, 126, 246, 0.5);
      }
      
      .pattern-card .card-body {
        color: #eaf3ff;
      }
      
      .pattern-card .card-title {
        color: var(--accent-blue, #38bdf8);
      }
      
      .pattern-card .card-text {
        color: rgba(255, 255, 255, 0.7);
      }

      /* Responsive breakpoints */
      @media (min-width: 768px) {
        .header-section {
          padding: 30px 0;
          margin-bottom: 30px;
        }
      }

      .exercise-container {
        display: none;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-top: 20px;
      }

      .pattern-zone {
        cursor: crosshair;
        opacity: 0.7;
      }

      .pattern-zone:hover {
        opacity: 1;
      }

      .feedback-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        display: none;
      }

      .progress-indicator {
        height: 6px;
        background: #e9ecef;
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 10px;
      }

      .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #007bff, #28a745);
        transition: width 0.3s ease;
      }

      .learning-stage-badge {
        font-size: 0.875rem;
        padding: 4px 12px;
        border-radius: 20px;
        font-weight: 500;
      }

      .stage-guided {
        background: #e3f2fd;
        color: #1565c0;
      }
      .stage-assisted {
        background: #e8f5e8;
        color: #2e7d32;
      }
      .stage-independent {
        background: #fff3e0;
        color: #f57c00;
      }
      .stage-mastery {
        background: #fce4ec;
        color: #c2185b;
      }

      /* Chart Container Styling */
      #chart-container {
        min-height: 550px;
        height: 550px;
        width: 100%;
        margin-top: 20px;
        margin-bottom: 30px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        background: white;
      }

      .exercise-container {
        margin-top: 30px;
      }

      .exercise-container .card-header {
        padding: 20px;
      }

      .exercise-container .card-body {
        padding: 20px;
      }
    </style>
  </head>
  <body class="pattern-page">
    {% include '_header.html' %}

    <div class="container" style="padding-top: 20px">
      <!-- Header Section -->
      <div class="header-section text-center">
        <h1 class="mb-3">üéØ Pattern Recognition Training</h1>
        <p class="lead mb-0">
          Master financial pattern recognition through interactive exercises
        </p>
        <div class="mt-3">
          <span
            class="learning-stage-badge stage-{{ user_stage.replace('_', '-') }}"
          >
            Learning Stage: {{ user_stage.replace('_', ' ').title() }}
          </span>
        </div>
      </div>

      <!-- Pattern Selection -->
      <div class="row" id="pattern-selection">
        <div class="col-12">
          <h3 class="text-center mb-4">Choose Your Training Focus</h3>
        </div>
        {% for pattern in available_patterns %}
        <div class="col-lg-4 col-md-6 col-sm-12 mb-3">
          <div
            class="card pattern-card h-100"
            onclick="selectPattern('{{ pattern.type }}')"
          >
            <div class="card-body text-center">
              <h5 class="card-title text-primary">{{ pattern.name }}</h5>
              <p class="card-text">{{ pattern.description }}</p>
              <div class="mt-auto">
                <button class="btn btn-outline-primary">
                  Select Pattern ‚Üí
                </button>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Stock Selection Panel -->
      <div class="row" id="stock-selection" style="display: none">
        <div class="col-12">
          <div class="card">
            <div
              class="card-header bg-info text-white d-flex justify-content-between align-items-center"
            >
              <h4 class="mb-0">üìà Choose Your Stock</h4>
              <button
                class="btn btn-sm btn-outline-light"
                onclick="backToPatterns()"
              >
                ‚Üê Back to Patterns
              </button>
            </div>
            <div class="card-body">
              <p class="lead mb-4">
                Select a stock to analyze or choose random selection:
              </p>

              <div class="row mb-3">
                <div class="col-md-6 col-sm-12 mb-2">
                  <button
                    class="btn btn-success btn-lg btn-block"
                    onclick="startExercise(selectedPatternType, null)"
                  >
                    üé≤ Random Stock
                  </button>
                  <small class="text-muted"
                    >Let the system choose a suitable company</small
                  >
                </div>
                <div class="col-md-6 col-sm-12">
                  <div class="form-group">
                    <label for="stock-dropdown" class="font-weight-bold"
                      >Or select specific stock:</label
                    >
                    <select
                      id="stock-dropdown"
                      class="form-control form-control-lg"
                    >
                      <option value="">Loading stocks...</option>
                    </select>
                  </div>
                  <button
                    class="btn btn-primary btn-lg btn-block"
                    onclick="startWithSelectedStock()"
                    id="start-selected-btn"
                    disabled
                  >
                    üéØ Start with Selected Stock
                  </button>
                </div>
              </div>

              <div class="text-center">
                <small class="text-muted">
                  <i class="fas fa-info-circle"></i>
                  Note: All exercises use synthetic educational data designed
                  for pattern recognition training.<br />
                  <i class="fas fa-mouse-pointer"></i>
                  Hover over highlighted areas and markers for pattern hints!
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Exercise Container -->
      <div id="exercise-container" class="exercise-container">
        <div
          class="card-header bg-primary text-white d-flex justify-content-between align-items-center"
        >
          <h4 class="mb-0" id="exercise-title">Pattern Recognition Exercise</h4>
          <div>
            <button
              class="btn btn-sm btn-outline-light ml-2"
              onclick="returnToSelection()"
            >
              ‚Üê Back to Selection
            </button>
          </div>
        </div>
        <div class="card-body">
          <!-- Exercise Description -->
          <div class="row mb-4">
            <div class="col-12">
              <p class="lead" id="exercise-description">Loading exercise...</p>
            </div>
          </div>

          <div class="row">
            <div class="col-md-9">
              <!-- Chart Container -->
              <div id="chart-container">
                <div class="text-center mt-5">
                  <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Loading chart...</span>
                  </div>
                  <p class="mt-2">Loading interactive chart...</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <!-- Instructions Panel -->
              <div class="card bg-light">
                <div class="card-header">
                  <h6 class="mb-0">üìã Instructions</h6>
                </div>
                <div class="card-body">
                  <p id="instructions-text" class="small">
                    Analyze the chart and identify the patterns present.
                  </p>

                  <!-- Pattern Selection Buttons -->
                  <div id="pattern-buttons" class="mt-3">
                    <h6 class="small text-muted">
                      Click patterns you identify:
                    </h6>
                    <div
                      class="btn-group-vertical btn-group-sm w-100"
                      id="pattern-button-group"
                    >
                      <!-- Dynamic pattern buttons will be inserted here -->
                    </div>
                  </div>

                  <!-- Submit Section -->
                  <div class="mt-4">
                    <button
                      class="btn btn-success btn-block"
                      id="submit-btn"
                      onclick="submitAttempt()"
                    >
                      Submit Analysis
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Feedback Section -->
          <div id="feedback-section" class="feedback-section">
            <h5>üìä Results & Feedback</h5>
            <div class="row">
              <div class="col-md-6">
                <div class="progress-indicator">
                  <div
                    class="progress-bar"
                    id="score-progress"
                    style="width: 0%"
                  ></div>
                </div>
                <p class="small text-muted mb-2">Accuracy Score</p>
                <h4 class="text-primary" id="accuracy-score">--</h4>
              </div>
              <div class="col-md-6">
                <p class="small text-muted mb-2">Time Taken</p>
                <h5 id="time-taken">--</h5>
              </div>
            </div>
            <div class="mt-3">
              <h6>Feedback:</h6>
              <div id="feedback-content">
                <!-- Feedback will be inserted here -->
              </div>
            </div>
            <div class="mt-3 text-center">
              <button class="btn btn-primary mr-2" onclick="startNewExercise()">
                Try Another Exercise
              </button>
              <button
                class="btn btn-outline-secondary"
                onclick="returnToSelection()"
              >
                Change Pattern Type
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- JavaScript -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
      let currentExercise = null;
      let startTime = null;
      let selectedPatterns = new Set();
      let selectedPatternType = null;
      let availableStocks = [];

      // Load available stocks when page loads
      $(document).ready(function () {
        loadAvailableStocks();
      });

      function loadAvailableStocks() {
        $.get("/pattern-training/stocks")
          .done(function (response) {
            if (response.success) {
              availableStocks = response.stocks;
              populateStockDropdown();
            } else {
              console.error("Failed to load stocks");
            }
          })
          .fail(function () {
            console.error("Network error loading stocks");
          });
      }

      function populateStockDropdown() {
        const dropdown = $("#stock-dropdown");
        dropdown.empty();
        dropdown.append('<option value="">Select a stock...</option>');

        availableStocks.forEach((stock) => {
          const value = `${stock.name}|${stock.ticker}|${stock.industry}`;
          const displayText = `${stock.name} (${stock.ticker}) - ${
            stock.index || "Unknown Index"
          }`;
          dropdown.append(`<option value="${value}">${displayText}</option>`);
        });

        // Enable the start button when a stock is selected
        dropdown.on("change", function () {
          $("#start-selected-btn").prop("disabled", !$(this).val());
        });
      }

      function selectPattern(patternType) {
        selectedPatternType = patternType;
        $("#pattern-selection").hide();
        $("#stock-selection").show();
      }

      function backToPatterns() {
        $("#stock-selection").hide();
        $("#pattern-selection").show();
        selectedPatternType = null;
      }

      function startWithSelectedStock() {
        const selectedStock = $("#stock-dropdown").val();
        if (!selectedStock) {
          alert("Please select a stock first");
          return;
        }
        startExercise(selectedPatternType, selectedStock);
      }

      function startExercise(patternType, selectedStock = null) {
        $("#pattern-selection").hide();
        $("#stock-selection").hide();
        $("#exercise-container").show();

        // Clear previous state
        selectedPatterns.clear();
        $("#feedback-section").hide();

        // Build request parameters
        let requestParams = {
          pattern_type: patternType,
          stage: "{{ user_stage }}",
        };

        if (selectedStock) {
          requestParams.stock = selectedStock;
        }

        // Load exercise
        $.get("/pattern-training/exercise", requestParams)
          .done(function (response) {
            if (response.success) {
              currentExercise = response.exercise;
              displayExercise(response.exercise);
            } else {
              alert("Failed to load exercise: " + response.error);
            }
          })
          .fail(function () {
            alert("Network error while loading exercise");
          });
      }

      function displayExercise(exercise) {
        // Set title and description
        $("#exercise-title").text(exercise.title);
        $("#exercise-description").text(exercise.description);
        
        // Update instructions panel with educational context
        if (exercise.educational_context) {
          $("#instructions-text").html(exercise.educational_context);
        } else {
          $("#instructions-text").text(exercise.description);
        }

        // Parse and render chart with Plotly
        console.log("Received chart data:", exercise.chart_html);

        try {
          const chartData = JSON.parse(exercise.chart_html);
          console.log("Parsed chart data:", chartData);

          // Clear the container first
          $("#chart-container").empty();

          // Configure chart layout with proper sizing
          const layout = {
            ...chartData.layout,
            height: 480,
            margin: { t: 60, b: 80, l: 80, r: 80 },
            showlegend: true,
            legend: {
              orientation: "h",
              y: -0.15,
              x: 0.5,
              xanchor: "center",
            },
            title: {
              ...chartData.layout?.title,
              y: 0.98, // Position title closer to top but within chart bounds
              yanchor: "top",
              font: {
                size: 16,
              },
            },
          };

          const config = {
            responsive: true,
            displayModeBar: true,
            displaylogo: false,
            modeBarButtonsToRemove: ["pan2d", "lasso2d", "select2d"],
            modeBarButtonsToAdd: [],
            toImageButtonOptions: {
              format: "png",
              filename: "pattern_chart",
              height: 500,
              width: 800,
              scale: 1,
            },
          };

          // Create the Plotly chart
          Plotly.newPlot("chart-container", chartData.data, layout, config);
          console.log("Chart rendered successfully");
        } catch (e) {
          console.error("Failed to parse chart data:", e);
          $("#chart-container").html(
            '<div class="alert alert-danger">Error loading chart. Please try again.</div>'
          );
        }

        // Create pattern buttons based on pattern type
        createPatternButtons(exercise.pattern_type);

        // Record start time for analytics (no countdown)
        startTime = Date.now();
      }

      function createPatternButtons(patternType) {
        const buttonGroup = $("#pattern-button-group");
        buttonGroup.empty();

        let patterns = [];

        if (patternType === "debt_analysis") {
          patterns = [
            { id: "deleveraging_trend", label: "Deleveraging Trend" },
            { id: "increasing_debt_trend", label: "Increasing Debt" },
            { id: "high_debt_periods", label: "High Debt Periods" },
            { id: "interest_coverage_concern", label: "Coverage Issues" },
          ];
        } else if (patternType === "growth_indicators") {
          patterns = [
            { id: "consistent_strong_roe", label: "Strong ROE" },
            { id: "roe_improvement_trend", label: "ROE Improvement" },
            { id: "healthy_revenue_growth", label: "Revenue Growth" },
          ];
        } else if (patternType === "value_traps") {
          patterns = [
            { id: "low_valuation", label: "Low Valuation" },
            {
              id: "deteriorating_fundamentals",
              label: "Deteriorating Fundamentals",
            },
            { id: "potential_value_trap", label: "Potential Value Trap" },
          ];
        }

        patterns.forEach((pattern) => {
          const btn = $(
            `<button type="button" class="btn btn-outline-primary btn-block mb-1" data-pattern="${pattern.id}" onclick="togglePattern('${pattern.id}')">${pattern.label}</button>`
          );
          buttonGroup.append(btn);
        });
      }

      function togglePattern(patternId) {
        const btn = $(`button[data-pattern="${patternId}"]`);

        if (selectedPatterns.has(patternId)) {
          selectedPatterns.delete(patternId);
          btn.removeClass("btn-primary").addClass("btn-outline-primary");
        } else {
          selectedPatterns.add(patternId);
          btn.removeClass("btn-outline-primary").addClass("btn-primary");
        }
      }

      function submitAttempt() {

        const timeTaken = Math.round((Date.now() - startTime) / 1000);

        $.ajax({
          url: "/pattern-training/submit",
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify({
            exercise_id: currentExercise.id,
            identified_patterns: Array.from(selectedPatterns),
            time_taken_seconds: timeTaken,
          }),
        })
          .done(function (response) {
            if (response.success) {
              displayFeedback(response.result, timeTaken);
            } else {
              alert("Failed to submit: " + response.error);
            }
          })
          .fail(function () {
            alert("Network error while submitting");
          });
      }

      function displayFeedback(result, timeTaken) {
        // Show accuracy
        const accuracy = Math.round(result.accuracy * 100);
        $("#accuracy-score").text(accuracy + "%");
        $("#score-progress").css("width", accuracy + "%");

        // Show time taken
        const minutes = Math.floor(timeTaken / 60);
        const seconds = timeTaken % 60;
        $("#time-taken").text(`${minutes}m ${seconds}s`);

        // Show feedback
        let feedbackHtml = `<div class="alert alert-info">${result.feedback}</div>`;

        if (result.missed_patterns && result.missed_patterns.length > 0) {
          feedbackHtml +=
            '<div class="alert alert-warning"><strong>Missed Patterns:</strong><ul>';
          result.missed_patterns.forEach((pattern) => {
            feedbackHtml += `<li>${pattern}</li>`;
          });
          feedbackHtml += "</ul></div>";
        }

        if (result.recommendations && result.recommendations.length > 0) {
          feedbackHtml +=
            '<div class="alert alert-success"><strong>Recommendations:</strong><ul>';
          result.recommendations.forEach((rec) => {
            feedbackHtml += `<li>${rec}</li>`;
          });
          feedbackHtml += "</ul></div>";
        }
        
        // Add "Walk Me Through It" button for low accuracy (< 50%)
        if (accuracy < 50) {
          feedbackHtml += `
            <div class="mt-3 text-center">
              <button class="btn btn-warning btn-lg" onclick="showCorrectPatterns()">
                üéì Walk Me Through It
              </button>
              <p class="small text-muted mt-2">See where the patterns were hiding</p>
            </div>
          `;
        }

        $("#feedback-content").html(feedbackHtml);
        $("#feedback-section").show();
        
        // Auto-scroll to feedback section for immediate visibility
        $("#feedback-section")[0].scrollIntoView({ behavior: "smooth", block: "start" });
      }
      
      function showCorrectPatterns() {
        // Highlight all expected patterns on the chart
        if (!currentExercise || !currentExercise.expected_patterns) {
          alert("Pattern data not available");
          return;
        }
        
        // Scroll back to chart
        $("#chart-container")[0].scrollIntoView({ behavior: "smooth", block: "center" });
        
        // Helper to convert snake_case to Title Case
        function formatPatternName(pattern) {
          return pattern.replace(/_/g, ' ')
                        .replace(/\b\w/g, l => l.toUpperCase());
        }
        
        // Show educational message
        let walkthruHtml = `
          <div class="alert alert-info mb-3" id="learning-mode-box">
            <h5>üéì Learning Mode</h5>
            <p>The correct patterns for this exercise were:</p>
            <ul>
        `;
        
        currentExercise.expected_patterns.forEach((pattern) => {
          // Highlight the pattern button using data-pattern attribute
          const btn = $(`button[data-pattern="${pattern}"]`);
          if (btn.length) {
            btn.removeClass("btn-outline-primary btn-primary")
               .addClass("btn-success");
            // Only add checkmark if not already there
            if (!btn.text().includes('‚úì')) {
              btn.append(' ‚úì');
            }
          }
          walkthruHtml += `<li><strong>${formatPatternName(pattern)}</strong></li>`;
        });
        
        walkthruHtml += `
            </ul>
            <p class="mb-0"><em>Look for the highlighted zones on the chart - these indicate where the patterns appear.</em></p>
          </div>
        `;
        
        // Remove existing learning mode box if present
        $("#learning-mode-box").remove();
        
        // Prepend learning content to feedback
        $("#feedback-content").prepend(walkthruHtml);
        
        // Disable the Walk Me Through It button after use
        $("button:contains('Walk Me Through It')").prop("disabled", true).text("‚úì Patterns Revealed");
      }

      function startNewExercise() {
        // Reset the current exercise with same pattern type
        if (currentExercise && selectedPatternType) {
          // Go back to stock selection for the same pattern
          $("#exercise-container").hide();
          $("#stock-selection").show();
        }
      }

      function returnToSelection() {

        $("#exercise-container").hide();
        $("#stock-selection").hide();
        $("#pattern-selection").show();
        currentExercise = null;
        selectedPatterns.clear();
        selectedPatternType = null;
      }
    </script>
    {% include '_footer.html' %}
  </body>
</html>
